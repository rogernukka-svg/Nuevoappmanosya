(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8998],{331:function(e,t,n){Promise.resolve().then(n.bind(n,2130))},2130:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return p}});var a=n(7437),r=n(2265),s=n(7818);n(966);var l=n(4667),i=n(6463);let o=(0,n(8030).Z)("rocket",[["path",{d:"M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z",key:"m3kijz"}],["path",{d:"m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z",key:"1fmvmk"}],["path",{d:"M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0",key:"1f8sc4"}],["path",{d:"M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5",key:"qeys4"}]]),c=(0,l.S)(),d=(0,s.default)(()=>Promise.all([n.e(4212),n.e(9720),n.e(9748)]).then(n.bind(n,9720)).then(e=>e.MapContainer),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),u=(0,s.default)(()=>Promise.all([n.e(4212),n.e(9720),n.e(9748)]).then(n.bind(n,9720)).then(e=>e.TileLayer),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),f=(0,s.default)(()=>Promise.all([n.e(4212),n.e(9720),n.e(9748)]).then(n.bind(n,9720)).then(e=>e.Marker),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),h=(0,s.default)(()=>Promise.all([n.e(4212),n.e(9720),n.e(9748)]).then(n.bind(n,9720)).then(e=>e.Tooltip),{loadableGenerated:{webpack:()=>[9720]},ssr:!1});function m(e){let{chatId:t,userId:n}=e,[s,l]=(0,r.useState)([]),[i,o]=(0,r.useState)("");async function d(e){e.preventDefault(),i.trim()&&(await c.from("chat_messages").insert([{chat_id:t,sender_id:n,message:i.trim()}]),o(""))}return(0,r.useEffect)(()=>{if(!t)return;c.from("chat_messages").select("*").eq("chat_id",t).order("created_at",{ascending:!0}).then(e=>{let{data:t}=e;return l(t||[])});let e=c.channel("chat-".concat(t)).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:"chat_id=eq.".concat(t)},e=>l(t=>[...t,e.new])).subscribe();return()=>c.removeChannel(e)},[t]),(0,a.jsxs)("div",{className:"flex flex-col h-72 bg-zinc-900 rounded-xl border border-white/10",children:[(0,a.jsx)("div",{className:"flex-1 overflow-y-auto p-3 space-y-2",children:s.map(e=>(0,a.jsx)("div",{className:"flex ".concat(e.sender_id===n?"justify-end":"justify-start"),children:(0,a.jsxs)("div",{className:"px-3 py-2 rounded-2xl max-w-[75%] ".concat(e.sender_id===n?"bg-emerald-500 text-black rounded-br-none":"bg-zinc-800 text-white rounded-bl-none"),children:[e.message,(0,a.jsx)("div",{className:"text-[10px] text-white/60 mt-1 text-right",children:new Date(e.created_at).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})})]})},e.id))}),(0,a.jsxs)("form",{onSubmit:d,className:"p-2 border-t border-white/10 flex gap-2",children:[(0,a.jsx)("input",{type:"text",value:i,onChange:e=>o(e.target.value),placeholder:"Escribir mensaje...",className:"flex-1 bg-zinc-800 text-white rounded-full px-3 py-2 text-sm focus:outline-none"}),(0,a.jsx)("button",{className:"bg-emerald-500 hover:bg-emerald-600 text-black font-semibold rounded-full px-4 transition-all active:scale-95",children:"\uD83D\uDCE8"})]})]})}function b(e){let{clientLat:t,clientLng:n}=e,[s,l]=(0,r.useState)(null);return((0,r.useEffect)(()=>{navigator.geolocation&&navigator.geolocation.getCurrentPosition(e=>{l([e.coords.latitude,e.coords.longitude])})},[]),s)?(0,a.jsx)("div",{className:"h-72 w-full rounded-xl overflow-hidden border border-white/10",children:(0,a.jsxs)(d,{center:s,zoom:13,style:{height:"100%",width:"100%"},children:[(0,a.jsx)(u,{url:"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"}),(0,a.jsx)(f,{position:s,children:(0,a.jsx)(h,{direction:"top",offset:[0,-10],opacity:1,children:(0,a.jsx)("span",{children:"Vos"})})}),t&&n&&(0,a.jsx)(f,{position:[t,n],children:(0,a.jsx)(h,{direction:"top",offset:[0,-10],opacity:1,children:(0,a.jsx)("span",{children:"Cliente"})})})]})}):(0,a.jsx)("div",{className:"text-white/70 text-center py-5",children:"\uD83D\uDCE1 Obteniendo ubicaci\xf3n…"})}function p(){let[e,t]=(0,r.useState)([]),[n,s]=(0,r.useState)(!0),[l,d]=(0,r.useState)(null),[u,f]=(0,r.useState)(null),[h,p]=(0,r.useState)(null),x=(0,i.useRouter)();function j(e){try{new Audio(e).play().catch(()=>{}),navigator.vibrate&&navigator.vibrate([200,100,200])}catch(e){}}async function g(t){try{let{error:n}=await c.rpc("accept_job",{p_job_id:t});if(n)throw n;j("/accepted.mp3"),p(e.find(e=>e.id===t))}catch(e){alert("Error al aceptar: "+e.message)}}async function w(e){try{let{error:t}=await c.from("jobs").update({status:"cancelled"}).eq("id",e);if(t)throw t;j("/cancelled.mp3")}catch(e){alert("Error al rechazar: "+e.message)}}return((0,r.useEffect)(()=>{c.auth.getUser().then(e=>{var t;let{data:n}=e,a=null==n?void 0:null===(t=n.user)||void 0===t?void 0:t.id;a&&f(a)})},[]),(0,r.useEffect)(()=>{u&&(async()=>{try{s(!0);let{data:e,error:n}=await c.rpc("fn_my_jobs");if(n)throw n;t(e||[])}catch(e){d(e.message)}finally{s(!1)}})()},[u]),(0,r.useEffect)(()=>{if(!u)return;let e=c.channel("jobs-worker-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"jobs"},e=>{let n=e.new;n.worker_id===u&&(t(e=>[n,...e]),j("/notify.mp3"))}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"jobs"},e=>{let n=e.new;n.worker_id===u&&(t(e=>e.map(e=>e.id===n.id?n:e)),"assigned"===n.status&&(j("/accepted.mp3"),p(n)),"completed"===n.status&&j("/completed.mp3"),"cancelled"===n.status&&j("/cancelled.mp3"))}).subscribe();return()=>c.removeChannel(e)},[u]),n)?(0,a.jsx)("div",{className:"p-5 text-center text-white/70",children:"Cargando trabajos…"}):(0,a.jsxs)("div",{className:"container",children:[(0,a.jsxs)("header",{className:"mt-6 mb-6 flex flex-col sm:flex-row items-center justify-between gap-3",children:[(0,a.jsx)("h1",{className:"text-2xl font-extrabold",children:"\uD83D\uDCCB Mis trabajos activos"}),(0,a.jsxs)("button",{onClick:()=>x.push("/worker/onboard"),className:"flex items-center gap-2 px-4 py-2 rounded-xl bg-gradient-to-r from-emerald-500 to-cyan-500 text-white text-sm font-semibold hover:from-emerald-600 hover:to-cyan-600 transition-all active:scale-95 shadow-md",children:[(0,a.jsx)(o,{className:"w-4 h-4"}),"Activar perfil"]})]}),l&&(0,a.jsx)("div",{className:"text-red-400 mb-3",children:l}),0===e.length?(0,a.jsx)("p",{className:"text-sm opacity-70",children:"No ten\xe9s trabajos activos."}):(0,a.jsx)("div",{className:"space-y-4",children:e.map(e=>(0,a.jsxs)("article",{className:"card p-4 flex justify-between items-center border border-white/10 rounded-lg",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"font-bold",children:e.title}),(0,a.jsxs)("p",{className:"text-sm opacity-70",children:["Estado: ",(0,a.jsx)("b",{children:e.status})]})]}),"open"===e.status?(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("button",{className:"btn btn-primary",onClick:()=>g(e.id),children:"✅ Aceptar"}),(0,a.jsx)("button",{className:"btn btn-ghost",onClick:()=>w(e.id),children:"❌ Rechazar"})]}):(0,a.jsx)("a",{href:"/worker/job/".concat(e.id),className:"btn btn-primary",children:"Abrir"})]},e.id))}),h&&(0,a.jsx)(function(e){let{job:t,onClose:n}=e,[s,l]=(0,r.useState)("info");return t?(0,a.jsx)("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-end justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-zinc-900 rounded-t-2xl w-full max-w-md p-6 border-t border-white/10",children:[(0,a.jsx)("div",{className:"w-12 h-1 bg-white/20 rounded-full mx-auto mb-4"}),(0,a.jsx)("h2",{className:"text-xl font-bold mb-2 text-center",children:"\uD83D\uDE97 Trabajo asignado"}),(0,a.jsx)("p",{className:"text-sm text-white/70 text-center mb-4",children:t.title}),(0,a.jsx)("div",{className:"flex justify-around mb-4",children:["info","chat","map"].map(e=>(0,a.jsx)("button",{onClick:()=>l(e),className:"px-3 py-1 rounded-full text-sm ".concat(s===e?"bg-emerald-500 text-black":"bg-zinc-800 text-white/70"),children:"info"===e?"\uD83D\uDCCB Info":"chat"===e?"\uD83D\uDCAC Chat":"\uD83D\uDCCD Mapa"},e))}),"info"===s&&(0,a.jsxs)("div",{className:"grid grid-cols-3 gap-3",children:[(0,a.jsx)("button",{className:"btn btn-primary",onClick:()=>{t.client_lat&&t.client_lng?window.open("https://www.google.com/maps/dir/?api=1&destination=".concat(t.client_lat,",").concat(t.client_lng),"_blank"):alert("\uD83D\uDCCD No hay coordenadas del cliente")},children:"Ver ruta"}),(0,a.jsx)("button",{className:"btn btn-secondary",onClick:()=>t.client_phone?window.open("tel:".concat(t.client_phone)):alert("\uD83D\uDCDE Sin tel\xe9fono"),children:"Llamar"}),(0,a.jsx)("button",{className:"btn btn-accent",onClick:()=>l("chat"),children:"Chat"})]}),"chat"===s&&(0,a.jsx)(m,{chatId:t.chat_room_id,userId:u}),"map"===s&&(0,a.jsx)(b,{clientLat:t.client_lat,clientLng:t.client_lng}),(0,a.jsx)("button",{className:"btn btn-ghost mt-4 w-full",onClick:()=>n(),children:"Cerrar"})]})}):null},{job:h,onClose:()=>p(null)})]})}},4667:function(e,t,n){"use strict";n.d(t,{S:function(){return s}});var a=n(951);let r=null;function s(){if(r)return r;let e="https://ydtficoxjuxsoaxtghhj.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkdGZpY294anV4c29heHRnaGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTUwNDIsImV4cCI6MjA3NTY3MTA0Mn0.KBRDCAJYvjpmcXRnYFcuSI8Mn0zYfJzaN0QJo63gzy8";if(!e||!t)throw console.error("❌ Faltan variables de entorno de Supabase."),Error("Variables de entorno Supabase no configuradas.");return r=(0,a.createBrowserClient)(e,t,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}),console.log("✅ Supabase (browser client) inicializado en",e),r}},8030:function(e,t,n){"use strict";n.d(t,{Z:function(){return u}});var a=n(2265);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let r=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),s=e=>e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,n)=>n?n.toUpperCase():t.toLowerCase()),l=e=>{let t=s(e);return t.charAt(0).toUpperCase()+t.slice(1)},i=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.filter((e,t,n)=>!!e&&""!==e.trim()&&n.indexOf(e)===t).join(" ").trim()},o=e=>{for(let t in e)if(t.startsWith("aria-")||"role"===t||"title"===t)return!0};/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var c={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let d=(0,a.forwardRef)((e,t)=>{let{color:n="currentColor",size:r=24,strokeWidth:s=2,absoluteStrokeWidth:l,className:d="",children:u,iconNode:f,...h}=e;return(0,a.createElement)("svg",{ref:t,...c,width:r,height:r,stroke:n,strokeWidth:l?24*Number(s)/Number(r):s,className:i("lucide",d),...!u&&!o(h)&&{"aria-hidden":"true"},...h},[...f.map(e=>{let[t,n]=e;return(0,a.createElement)(t,n)}),...Array.isArray(u)?u:[u]])}),u=(e,t)=>{let n=(0,a.forwardRef)((n,s)=>{let{className:o,...c}=n;return(0,a.createElement)(d,{ref:s,iconNode:t,className:i("lucide-".concat(r(l(e))),"lucide-".concat(e),o),...c})});return n.displayName=l(e),n}},7818:function(e,t,n){"use strict";n.d(t,{default:function(){return r.a}});var a=n(551),r=n.n(a)},6463:function(e,t,n){"use strict";var a=n(1169);n.o(a,"useParams")&&n.d(t,{useParams:function(){return a.useParams}}),n.o(a,"usePathname")&&n.d(t,{usePathname:function(){return a.usePathname}}),n.o(a,"useRouter")&&n.d(t,{useRouter:function(){return a.useRouter}})},551:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return s}});let a=n(9920);n(7437),n(2265);let r=a._(n(148));function s(e,t){var n;let a={loading:e=>{let{error:t,isLoading:n,pastDelay:a}=e;return null}};"function"==typeof e&&(a.loader=e);let s={...a,...t};return(0,r.default)({...s,modules:null==(n=s.loadableGenerated)?void 0:n.modules})}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},912:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"BailoutToCSR",{enumerable:!0,get:function(){return r}});let a=n(5592);function r(e){let{reason:t,children:n}=e;if("undefined"==typeof window)throw new a.BailoutToCSRError(t);return n}},148:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return c}});let a=n(7437),r=n(2265),s=n(912),l=n(1481);function i(e){return{default:e&&"default"in e?e.default:e}}let o={loader:()=>Promise.resolve(i(()=>null)),loading:null,ssr:!0},c=function(e){let t={...o,...e},n=(0,r.lazy)(()=>t.loader().then(i)),c=t.loading;function d(e){let i=c?(0,a.jsx)(c,{isLoading:!0,pastDelay:!0,error:null}):null,o=t.ssr?(0,a.jsxs)(a.Fragment,{children:["undefined"==typeof window?(0,a.jsx)(l.PreloadCss,{moduleIds:t.modules}):null,(0,a.jsx)(n,{...e})]}):(0,a.jsx)(s.BailoutToCSR,{reason:"next/dynamic",children:(0,a.jsx)(n,{...e})});return(0,a.jsx)(r.Suspense,{fallback:i,children:o})}return d.displayName="LoadableComponent",d}},1481:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"PreloadCss",{enumerable:!0,get:function(){return s}});let a=n(7437),r=n(8512);function s(e){let{moduleIds:t}=e;if("undefined"!=typeof window)return null;let n=(0,r.getExpectedRequestStore)("next/dynamic css"),s=[];if(n.reactLoadableManifest&&t){let e=n.reactLoadableManifest;for(let n of t){if(!e[n])continue;let t=e[n].files.filter(e=>e.endsWith(".css"));s.push(...t)}}return 0===s.length?null:(0,a.jsx)(a.Fragment,{children:s.map(e=>(0,a.jsx)("link",{precedence:"dynamic",rel:"stylesheet",href:n.assetPrefix+"/_next/"+encodeURI(e),as:"style"},e))})}},966:function(){}},function(e){e.O(0,[2733,951,2971,7023,1744],function(){return e(e.s=331)}),_N_E=e.O()}]);