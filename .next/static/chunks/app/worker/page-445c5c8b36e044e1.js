(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7706],{5910:function(e,t,a){Promise.resolve().then(a.bind(a,6370))},6370:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return g}});var r=a(7437),s=a(2265),i=a(6463),n=a(3763),o=a(5348),l=a(4378),c=a(3274),d=a(3231),u=a(2472),m=a(374),x=a(518),f=a(7091),h=a(7776);let p=(0,a(4667).S)();async function b(e){if(e)try{let{data:t}=await p.from("worker_profiles").select("user_id").eq("user_id",e).maybeSingle();t||await p.from("worker_profiles").insert([{user_id:e,is_active:!0,radius_km:5}])}catch(e){console.error("Error creando worker_profile:",e.message)}}function g(){let e=(0,i.useRouter)(),[t,a]=(0,s.useState)(null),[g,j]=(0,s.useState)([]),[w,y]=(0,s.useState)(!0),[v,_]=(0,s.useState)(null),[N,k]=(0,s.useState)([]),[C,z]=(0,s.useState)(!1),[E,S]=(0,s.useState)(!1),I=(0,s.useRef)(null),A=(0,s.useRef)(null),T=(0,s.useRef)(null),R=(0,s.useRef)(null);async function D(e){try{let{data:a,error:r}=await p.rpc("accept_job_flow",{p_job_id:e.id,p_worker_id:t.id});if(r||!(null==a?void 0:a.ok))throw r||Error((null==a?void 0:a.message)||"No se pudo aceptar el trabajo");h.A.success("✅ Trabajo aceptado correctamente"),j(t=>t.map(t=>t.id===e.id?{...t,status:a.status||"accepted"}:t)),await V(e),window.open("https://www.google.com/maps/dir/?api=1&destination=".concat(e.client_lat,",").concat(e.client_lng),"_blank")}catch(e){console.error("Error al aceptar trabajo:",e),h.A.error(e.message||"No se pudo aceptar el trabajo")}}async function Z(e){try{let{data:a,error:r}=await p.rpc("reject_job_flow",{p_job_id:e.id,p_worker_id:t.id});if(r)throw r;if(!(null==a?void 0:a.ok)){h.A.warning((null==a?void 0:a.message)||"No se pudo rechazar");return}h.A.success("\uD83D\uDEAB Trabajo rechazado correctamente"),j(t=>t.filter(t=>t.id!==e.id))}catch(e){console.error("Error al rechazar trabajo:",e),h.A.error(e.message||"No se pudo rechazar el trabajo")}}async function J(e){try{let{data:a,error:r}=await p.rpc("complete_job_flow",{p_job_id:e.id,p_worker_id:t.id});if(r)throw r;if(!(null==a?void 0:a.ok)){h.A.warning((null==a?void 0:a.message)||"No se pudo finalizar");return}h.A.success("\uD83C\uDF89 Trabajo finalizado correctamente"),j(t=>t.map(t=>t.id===e.id?{...t,status:"completed"}:t)),_(null),z(!1)}catch(e){console.error("Error al finalizar trabajo:",e),h.A.error(e.message||"No se pudo finalizar el trabajo")}}async function V(e){try{let{data:a,error:r}=await p.rpc("ensure_chat_for_job",{p_job_id:e.id});if(r)throw r;let{data:s}=await p.from("messages").select("*").eq("chat_id",a).order("created_at",{ascending:!0});k(s||[]),z(!0),_({...e,chat_id:a}),A.current&&p.removeChannel(A.current);let i=p.channel("chat-".concat(a),{config:{broadcast:{self:!0},presence:{key:t.id}}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:"chat_id=eq.".concat(a)},e=>{if(k(t=>[...t,e.new]),e.new.sender_id!==t.id){var a,r;null===(r=R.current)||void 0===r||null===(a=r.play)||void 0===a||a.call(r)}setTimeout(()=>{var e;return null===(e=T.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth"})},200)}).subscribe(async e=>{"SUBSCRIBED"===e&&console.log("✅ Realtime conectado al chat ".concat(a))});A.current=i}catch(e){console.error("Error en openChat:",e),h.A.error("No se pudo abrir el chat")}}async function M(e){let a=(e||"").trim();if(a&&v)try{S(!0),await p.from("messages").insert([{chat_id:v.chat_id,sender_id:t.id,content:a}])}finally{S(!1),setTimeout(()=>{var e;return null===(e=T.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth"})},200)}}return(0,s.useEffect)(()=>{(async()=>{try{"undefined"!=typeof Audio&&(R.current=new Audio("/notify.mp3"));let{data:t,error:r}=await p.auth.getUser();if(r)throw r;(null==t?void 0:t.user)?(a(t.user),await b(t.user.id)):e.replace("/login")}catch(t){console.error("Error inicializando sesi\xf3n:",t),h.A.error("Error al obtener usuario o sesi\xf3n expirada"),e.replace("/login")}})()},[e]),(0,s.useEffect)(()=>{(null==t?void 0:t.id)&&(async()=>{try{y(!0);let{data:e,error:t}=await p.from("jobs").select("\n            id, title, description, status, client_id, worker_id,\n            client_lat, client_lng, created_at,\n            client:profiles!client_id(full_name, avatar_url)\n          ").order("created_at",{ascending:!1});if(t)throw t;j(e||[])}catch(e){console.error("Error cargando trabajos:",e),h.A.error("Error al cargar trabajos")}finally{y(!1)}})()},[t]),(0,r.jsxs)(n.E.div,{initial:{opacity:0},animate:{opacity:1},className:"container max-w-screen-md mx-auto px-4 pb-28 bg-white text-gray-900 min-h-screen",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4 pt-6",children:[(0,r.jsx)("h1",{className:"text-lg font-extrabold text-emerald-600",children:"Panel del Trabajador"}),(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsxs)("button",{onClick:()=>e.push("/role-selector"),className:"flex items-center gap-1 text-sm font-semibold text-cyan-600 hover:text-cyan-800 transition",children:[(0,r.jsx)(l.Z,{size:16})," Cambiar rol"]}),(0,r.jsx)("button",{onClick:()=>e.push("/worker/onboard"),className:"text-sm font-semibold text-gray-400 hover:text-emerald-500 transition",children:"⚙️ Configurar perfil"})]})]}),w?(0,r.jsxs)("div",{className:"flex justify-center mt-10 text-gray-400",children:[(0,r.jsx)(c.Z,{className:"animate-spin"})," Cargando trabajos..."]}):0===g.length?(0,r.jsx)("p",{className:"text-gray-500 mt-10 text-center",children:"A\xfan no ten\xe9s solicitudes disponibles."}):(0,r.jsx)("section",{className:"grid gap-3 mt-5",children:g.map(e=>{var t,a,s;return(0,r.jsxs)(n.E.div,{whileTap:{scale:.97},className:"border rounded-2xl p-4 transition shadow-sm bg-white hover:shadow-md",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsx)("h3",{className:"font-bold text-gray-800",children:e.title||"Trabajo de Servicio"}),(0,r.jsx)(d.Z,{size:20,className:"text-emerald-500 opacity-80"})]}),(0,r.jsx)("p",{className:"text-sm text-gray-600",children:e.description||"Pedido generado desde el mapa"}),e.client&&(0,r.jsxs)("div",{className:"flex items-center gap-2 mt-2",children:[(0,r.jsx)("img",{src:(null===(t=e.client)||void 0===t?void 0:t.avatar_url)||"/avatar-fallback.png",alt:(null===(a=e.client)||void 0===a?void 0:a.full_name)||"Cliente",className:"w-6 h-6 rounded-full border border-gray-200"}),(0,r.jsx)("p",{className:"text-sm text-gray-700 font-medium",children:(null===(s=e.client)||void 0===s?void 0:s.full_name)||"Cliente sin nombre"})]}),(0,r.jsxs)("p",{className:"text-xs text-emerald-600 mt-2 font-medium",children:["Estado: ",e.status]}),"open"===e.status&&(0,r.jsxs)("div",{className:"flex gap-2 mt-3",children:[(0,r.jsx)("button",{onClick:()=>D(e),className:"flex-1 bg-emerald-500 text-white py-2 rounded-xl hover:bg-emerald-600 font-semibold",children:"Aceptar"}),(0,r.jsx)("button",{onClick:()=>Z(e),className:"flex-1 bg-gray-200 text-gray-700 py-2 rounded-xl hover:bg-gray-300 font-semibold",children:"Rechazar"})]}),"accepted"===e.status&&(0,r.jsxs)("div",{className:"flex flex-col gap-2 mt-3",children:[(0,r.jsxs)("button",{onClick:()=>window.open("https://www.google.com/maps/dir/?api=1&destination=".concat(e.client_lat,",").concat(e.client_lng),"_blank"),className:"w-full bg-emerald-100 text-emerald-700 py-2 rounded-xl font-semibold hover:bg-emerald-200 transition flex items-center justify-center gap-1",children:[(0,r.jsx)(u.Z,{size:16})," Ver ubicaci\xf3n"]}),(0,r.jsx)("button",{onClick:()=>V(e),className:"w-full bg-gray-100 text-gray-800 py-2 rounded-xl font-semibold hover:bg-gray-200 transition",children:"\uD83D\uDCAC Chat con cliente"}),(0,r.jsxs)("button",{onClick:()=>J(e),className:"w-full bg-emerald-600 text-white py-2 rounded-xl font-semibold hover:bg-emerald-700 transition flex items-center justify-center gap-1",children:[(0,r.jsx)(m.Z,{size:16})," Finalizar trabajo"]})]}),"completed"===e.status&&(0,r.jsx)("div",{className:"mt-3 text-center text-emerald-600 font-medium",children:"✅ Trabajo finalizado"})]},e.id)})}),(0,r.jsx)(o.M,{children:C&&v&&(0,r.jsx)(n.E.div,{className:"fixed inset-0 bg-black/40 flex justify-center items-end z-[80]",children:(0,r.jsxs)(n.E.div,{className:"bg-white rounded-t-3xl w-full max-w-md shadow-xl",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-100 bg-gray-50",children:[(0,r.jsxs)("button",{onClick:()=>z(!1),className:"flex items-center gap-1 text-gray-600 hover:text-red-500",children:[(0,r.jsx)(x.Z,{size:18})," Volver"]}),(0,r.jsx)("h2",{className:"font-semibold text-gray-800",children:"Chat con cliente"}),(0,r.jsxs)("button",{onClick:()=>window.open("https://www.google.com/maps/dir/?api=1&destination=".concat(v.client_lat,",").concat(v.client_lng),"_blank"),className:"flex items-center gap-1 text-emerald-600 hover:text-emerald-800 text-sm font-semibold",children:[(0,r.jsx)(u.Z,{size:16})," Mapa"]})]}),(0,r.jsxs)("div",{className:"flex flex-col h-[70vh] bg-white",children:[(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto px-4 py-3 space-y-2",children:[N.map(e=>{let a=e.sender_id===(null==t?void 0:t.id);return(0,r.jsx)("div",{className:"flex ".concat(a?"justify-end":"justify-start"),children:(0,r.jsxs)("div",{className:"max-w-[80%] px-3 py-2 rounded-2xl text-sm shadow-sm ".concat(a?"bg-emerald-500 text-white":"bg-gray-100 text-gray-800"),children:[e.content,(0,r.jsx)("div",{className:"text-[10px] mt-1 opacity-70 ".concat(a?"text-white":"text-gray-500"),children:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},e.id)}),(0,r.jsx)("div",{ref:T})]}),(0,r.jsxs)("form",{className:"p-3 border-t border-gray-100 flex gap-2",onSubmit:async e=>{var t;e.preventDefault();let a=(null===(t=I.current)||void 0===t?void 0:t.value)||"";await M(a),I.current&&(I.current.value="")},children:[(0,r.jsx)("input",{ref:I,type:"text",placeholder:"Escrib\xed un mensaje…",className:"flex-1 bg-gray-100 rounded-xl px-3 py-3 outline-none focus:ring-2 focus:ring-emerald-400 border border-gray-200"}),(0,r.jsx)("button",{disabled:E,className:"px-4 rounded-xl bg-emerald-500 text-white font-semibold hover:bg-emerald-600 transition disabled:opacity-60",children:(0,r.jsx)(f.Z,{size:18})})]})]})]})})})]})}},4667:function(e,t,a){"use strict";a.d(t,{S:function(){return i}});var r=a(951);let s=null;function i(){if(s)return s;let e="https://ydtficoxjuxsoaxtghhj.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkdGZpY294anV4c29heHRnaGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTUwNDIsImV4cCI6MjA3NTY3MTA0Mn0.KBRDCAJYvjpmcXRnYFcuSI8Mn0zYfJzaN0QJo63gzy8";if(!e||!t)throw console.error("❌ Faltan variables de entorno de Supabase."),Error("Variables de entorno Supabase no configuradas.");return s=(0,r.createBrowserClient)(e,t,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}),console.log("✅ Supabase (browser client) inicializado en",e),s}}},function(e){e.O(0,[951,7776,3642,4383,2971,7023,1744],function(){return e(e.s=5910)}),_N_E=e.O()}]);