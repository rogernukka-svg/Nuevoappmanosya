(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9463],{493:function(e,t,n){Promise.resolve().then(n.bind(n,7511))},7511:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return j}});var a=n(7437),s=n(2265),l=n(6463),r=n(7138),o=n(7818);n(966);var i=n(4667),c=n(357);let u=(0,o.default)(()=>Promise.all([n.e(4212),n.e(9720),n.e(9748)]).then(n.bind(n,9720)).then(e=>e.MapContainer),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),d=(0,o.default)(()=>Promise.all([n.e(4212),n.e(9720),n.e(9748)]).then(n.bind(n,9720)).then(e=>e.TileLayer),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),f=(0,o.default)(()=>Promise.all([n.e(4212),n.e(9720),n.e(9748)]).then(n.bind(n,9720)).then(e=>e.Marker),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),b=(0,o.default)(()=>Promise.all([n.e(4212),n.e(9720),n.e(9748)]).then(n.bind(n,9720)).then(e=>e.Tooltip),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),h=(0,o.default)(()=>Promise.all([n.e(4212),n.e(9720),n.e(9748)]).then(n.bind(n,9720)).then(e=>e.Polyline),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),p=c.env.NEXT_PUBLIC_ORS_KEY;function m(e){let t=new SpeechSynthesisUtterance(e);t.lang="es-ES",t.pitch=1,t.rate=1,t.volume=1,window.speechSynthesis.cancel(),window.speechSynthesis.speak(t)}function x(e){let{status:t}=e,n={open:{text:"\uD83D\uDCE6 Esperando asignaci\xf3n",cls:"bg-white/10 text-white"},assigned:{text:"\uD83E\uDDED Asignado",cls:"bg-emerald-500 text-black"},on_route:{text:"\uD83D\uDE97 En camino",cls:"bg-cyan-400 text-black"},arrived:{text:"\uD83D\uDCCD Lleg\xf3 al destino",cls:"bg-indigo-400 text-black"},done:{text:"✅ Completado",cls:"bg-emerald-400 text-black"},canceled:{text:"❌ Cancelado",cls:"bg-red-500 text-black"}}[t]||{text:t||"—",cls:"bg-white/10 text-white"};return(0,a.jsx)("span",{className:"px-3 py-1.5 rounded-full text-sm font-bold ".concat(n.cls),children:n.text})}function j(){let{id:e}=(0,l.useParams)(),[t,n]=(0,s.useState)(null),[o,c]=(0,s.useState)(!0),[j,g]=(0,s.useState)(null),[w,y]=(0,s.useState)(null),[v,k]=(0,s.useState)([]),[C,_]=(0,s.useState)(null),[N,P]=(0,s.useState)(null);async function S(e,t){try{let n=await fetch("https://api.openrouteservice.org/v2/directions/driving-car?api_key=".concat(p,"&start=").concat(e.lon,",").concat(e.lat,"&end=").concat(t.lon,",").concat(t.lat)),a=await n.json(),s=a.features[0].geometry.coordinates.map(e=>[e[1],e[0]]);k(s);let l=a.features[0].properties.segments[0].distance,r=a.features[0].properties.segments[0].duration;P((l/1e3).toFixed(1)),_(Math.round(r/60))}catch(e){console.error("Error ORS:",e)}}(0,s.useEffect)(()=>{e&&(async()=>{try{c(!0);let{data:t,error:a}=await i.supabase.from("jobs").select("*").eq("id",e).maybeSingle();if(a)throw a;if(!t)throw Error("Trabajo no encontrado");n(t)}catch(e){g(e.message)}finally{c(!1)}})()},[e]),(0,s.useEffect)(()=>{if(!e)return;let t=i.supabase.channel("job-".concat(e)).on("postgres_changes",{event:"UPDATE",schema:"public",table:"jobs",filter:"id=eq.".concat(e)},e=>{let t=e.new;if(n(t),"arrived"===t.status&&m("Has llegado al cliente."),"done"===t.status&&m("Trabajo completado con \xe9xito."),"canceled"===t.status&&m("Atenci\xf3n. El trabajo ha sido cancelado."),t.worker_lat&&t.worker_lng){let e={lat:t.worker_lat,lon:t.worker_lng};y(e),t.lat&&t.lon&&S(e,{lat:t.lat,lon:t.lon})}}).subscribe();return()=>i.supabase.removeChannel(t)},[e]);let D=(0,s.useMemo)(()=>"number"==typeof(null==t?void 0:t.lat)&&"number"==typeof(null==t?void 0:t.lon),[t]);async function E(){await i.supabase.from("jobs").update({status:"arrived"}).eq("id",e),n(e=>({...e,status:"arrived"})),m("Has marcado tu llegada al cliente.")}async function I(){await i.supabase.from("jobs").update({status:"done"}).eq("id",e),n(e=>({...e,status:"done"})),m("Trabajo finalizado con \xe9xito. \xa1Buen trabajo!")}async function O(){confirm("\xbfQuer\xe9s cancelar este trabajo?")&&(await i.supabase.from("jobs").update({status:"canceled"}).eq("id",e),n(e=>({...e,status:"canceled"})),m("Trabajo cancelado correctamente."))}return o?(0,a.jsx)("div",{className:"container",children:(0,a.jsx)("div",{className:"card p-5 mt-6 text-center text-white/70",children:"⏳ Cargando pedido…"})}):j?(0,a.jsx)("div",{className:"container",children:(0,a.jsxs)("div",{className:"card p-5 mt-6 text-center text-red-400",children:["⚠️ Error: ",j]})}):t?(0,a.jsxs)("div",{className:"container py-6",children:[(0,a.jsxs)("header",{className:"text-center mb-6",children:[(0,a.jsx)("h1",{className:"text-2xl font-extrabold mb-2",children:t.title||"Trabajo"}),(0,a.jsx)(x,{status:t.status}),(0,a.jsxs)("p",{className:"mt-2 text-white/70 text-sm",children:["Publicado: ",new Date(t.created_at).toLocaleString()]})]}),D&&(0,a.jsxs)("section",{className:"card p-4 mb-6",children:[(0,a.jsx)("h2",{className:"font-bold mb-3 text-lg text-center",children:"\uD83D\uDCCD Ubicaci\xf3n del cliente"}),(0,a.jsx)("div",{className:"w-full rounded-2xl overflow-hidden",style:{height:320},children:(0,a.jsxs)(u,{center:[t.lat,t.lon],zoom:14,style:{height:"100%",width:"100%"},children:[(0,a.jsx)(d,{url:"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"}),(0,a.jsx)(f,{position:[t.lat,t.lon],children:(0,a.jsx)(b,{children:"Cliente"})}),w&&(0,a.jsx)(f,{position:[w.lat,w.lon],children:(0,a.jsx)(b,{children:"Vos (trabajador)"})}),v.length>0&&(0,a.jsx)(h,{positions:v,pathOptions:{color:"#14B8A6",weight:5}})]})}),C&&N&&(0,a.jsxs)("p",{className:"mt-3 text-center text-sm text-white/80",children:["\uD83D\uDE97 Distancia: ",(0,a.jsxs)("strong",{children:[N," km"]})," • ⏱ Tiempo estimado: ",(0,a.jsxs)("strong",{children:[C," min"]})]})]}),(0,a.jsxs)("section",{className:"card p-6 text-center space-y-3",children:[(0,a.jsx)("h3",{className:"font-bold text-lg mb-3",children:"Acciones r\xe1pidas"}),"open"===t.status&&(0,a.jsx)("button",{className:"btn bg-red-600 text-white py-3 text-lg w-full",onClick:O,children:"❌ Cancelar trabajo"}),"arrived"!==t.status&&"done"!==t.status&&"canceled"!==t.status&&(0,a.jsx)("button",{className:"btn bg-cyan-500 text-black py-3 text-lg w-full",onClick:E,children:"✅ Marcar llegada"}),"arrived"===t.status&&(0,a.jsx)("button",{className:"btn bg-emerald-500 text-black py-3 text-lg w-full",onClick:I,children:"\uD83C\uDFC1 Finalizar trabajo"}),(0,a.jsx)(r.default,{href:"/worker/jobs",className:"btn bg-white/10 text-white py-3 w-full mt-4",children:"← Volver a mis trabajos"})]})]}):(0,a.jsx)("div",{className:"container",children:(0,a.jsx)("div",{className:"card p-5 mt-6 text-center",children:"Trabajo no encontrado."})})}},4667:function(e,t,n){"use strict";n.d(t,{S:function(){return l}});var a=n(951);let s=null;function l(){if(s)return s;let e="https://ydtficoxjuxsoaxtghhj.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkdGZpY294anV4c29heHRnaGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTUwNDIsImV4cCI6MjA3NTY3MTA0Mn0.KBRDCAJYvjpmcXRnYFcuSI8Mn0zYfJzaN0QJo63gzy8";if(!e||!t)throw console.error("❌ Faltan variables de entorno de Supabase."),Error("Variables de entorno Supabase no configuradas.");return s=(0,a.createBrowserClient)(e,t,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}),console.log("✅ Supabase (browser client) inicializado en",e),s}},7818:function(e,t,n){"use strict";n.d(t,{default:function(){return s.a}});var a=n(551),s=n.n(a)},7138:function(e,t,n){"use strict";n.d(t,{default:function(){return s.a}});var a=n(231),s=n.n(a)},6463:function(e,t,n){"use strict";var a=n(1169);n.o(a,"useParams")&&n.d(t,{useParams:function(){return a.useParams}}),n.o(a,"usePathname")&&n.d(t,{usePathname:function(){return a.usePathname}}),n.o(a,"useRouter")&&n.d(t,{useRouter:function(){return a.useRouter}})},551:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return l}});let a=n(9920);n(7437),n(2265);let s=a._(n(148));function l(e,t){var n;let a={loading:e=>{let{error:t,isLoading:n,pastDelay:a}=e;return null}};"function"==typeof e&&(a.loader=e);let l={...a,...t};return(0,s.default)({...l,modules:null==(n=l.loadableGenerated)?void 0:n.modules})}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},912:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"BailoutToCSR",{enumerable:!0,get:function(){return s}});let a=n(5592);function s(e){let{reason:t,children:n}=e;if("undefined"==typeof window)throw new a.BailoutToCSRError(t);return n}},148:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return c}});let a=n(7437),s=n(2265),l=n(912),r=n(1481);function o(e){return{default:e&&"default"in e?e.default:e}}let i={loader:()=>Promise.resolve(o(()=>null)),loading:null,ssr:!0},c=function(e){let t={...i,...e},n=(0,s.lazy)(()=>t.loader().then(o)),c=t.loading;function u(e){let o=c?(0,a.jsx)(c,{isLoading:!0,pastDelay:!0,error:null}):null,i=t.ssr?(0,a.jsxs)(a.Fragment,{children:["undefined"==typeof window?(0,a.jsx)(r.PreloadCss,{moduleIds:t.modules}):null,(0,a.jsx)(n,{...e})]}):(0,a.jsx)(l.BailoutToCSR,{reason:"next/dynamic",children:(0,a.jsx)(n,{...e})});return(0,a.jsx)(s.Suspense,{fallback:o,children:i})}return u.displayName="LoadableComponent",u}},1481:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"PreloadCss",{enumerable:!0,get:function(){return l}});let a=n(7437),s=n(8512);function l(e){let{moduleIds:t}=e;if("undefined"!=typeof window)return null;let n=(0,s.getExpectedRequestStore)("next/dynamic css"),l=[];if(n.reactLoadableManifest&&t){let e=n.reactLoadableManifest;for(let n of t){if(!e[n])continue;let t=e[n].files.filter(e=>e.endsWith(".css"));l.push(...t)}}return 0===l.length?null:(0,a.jsx)(a.Fragment,{children:l.map(e=>(0,a.jsx)("link",{precedence:"dynamic",rel:"stylesheet",href:n.assetPrefix+"/_next/"+encodeURI(e),as:"style"},e))})}},966:function(){}},function(e){e.O(0,[2733,951,231,2971,7023,1744],function(){return e(e.s=493)}),_N_E=e.O()}]);