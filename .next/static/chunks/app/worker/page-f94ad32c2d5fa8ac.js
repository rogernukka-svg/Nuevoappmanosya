(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7706],{5910:function(e,t,a){Promise.resolve().then(a.bind(a,6370))},6370:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return y}});var r=a(7437),s=a(2265),i=a(6463),n=a(3763),l=a(5348),o=a(2558),c=a(257),d=a(3274),u=a(2472),m=a(374),x=a(518),f=a(7091),p=a(3852),h=a(7583),b=a(1145),g=a(7776);let j=(0,a(4667).S)();async function w(e){if(e)try{let{data:t}=await j.from("worker_profiles").select("user_id").eq("user_id",e).maybeSingle();t||await j.from("worker_profiles").insert([{user_id:e,is_active:!0,radius_km:5,lat:null,lng:null}])}catch(e){console.error("Error creando worker_profile:",e.message)}}function y(){let e=(0,i.useRouter)(),[t,a]=(0,s.useState)(null),[y,v]=(0,s.useState)([]),[_,N]=(0,s.useState)(!0),[k,C]=(0,s.useState)(null),[z,A]=(0,s.useState)([]),[E,D]=(0,s.useState)(!1),[S,I]=(0,s.useState)(!1),[T,Z]=(0,s.useState)(!0),[R,J]=(0,s.useState)(!1),V=(0,s.useRef)(null),q=(0,s.useRef)(null),F=(0,s.useRef)(null),M=(0,s.useRef)(null);async function Y(){try{let e=!T;Z(e),await j.from("worker_profiles").update({is_active:e}).eq("user_id",t.id),g.A.success(e?"\uD83D\uDFE2 Ahora est\xe1s disponible":"\uD83D\uDD34 Est\xe1s pausado")}catch(e){g.A.error("No se pudo cambiar tu estado")}}async function O(e){try{if("open"!==e.status)return g.A.warning("Este trabajo ya fue tomado");let{data:a,error:r}=await j.rpc("accept_job_flow",{p_job_id:e.id,p_worker_id:t.id});if(r||!(null==a?void 0:a.ok))throw r||Error((null==a?void 0:a.message)||"No se pudo aceptar el trabajo");g.A.success("✅ Trabajo aceptado correctamente"),v(t=>t.map(t=>t.id===e.id?{...t,status:a.status||"accepted"}:t)),await B(e),window.open("https://www.google.com/maps/dir/?api=1&destination=".concat(e.client_lat,",").concat(e.client_lng),"_blank")}catch(e){g.A.error(e.message||"No se pudo aceptar el trabajo")}}async function P(e){try{let{data:a,error:r}=await j.rpc("reject_job_flow",{p_job_id:e.id,p_worker_id:t.id});if(r)throw r;if(!(null==a?void 0:a.ok))return g.A.warning((null==a?void 0:a.message)||"No se pudo rechazar");g.A.success("\uD83D\uDEAB Trabajo rechazado correctamente"),v(t=>t.filter(t=>t.id!==e.id))}catch(e){g.A.error(e.message||"No se pudo rechazar el trabajo")}}async function U(e){try{let{data:a,error:r}=await j.rpc("complete_job_flow",{p_job_id:e.id,p_worker_id:t.id});if(r)throw r;if(!(null==a?void 0:a.ok))return g.A.warning((null==a?void 0:a.message)||"No se pudo finalizar");g.A.success("\uD83C\uDF89 Trabajo finalizado correctamente"),v(t=>t.map(t=>t.id===e.id?{...t,status:"completed"}:t)),C(null),D(!1)}catch(e){g.A.error(e.message||"No se pudo finalizar el trabajo")}}async function B(e){try{let{data:a,error:r}=await j.rpc("ensure_chat_for_job",{p_job_id:e.id});if(r)throw r;let{data:s}=await j.from("messages").select("*").eq("chat_id",a).order("created_at",{ascending:!0});A(s||[]),D(!0),C({...e,chat_id:a}),q.current&&j.removeChannel(q.current);let i=j.channel("chat-".concat(a)).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:"chat_id=eq.".concat(a)},e=>{var a,r;A(t=>[...t,e.new]),e.new.sender_id!==t.id&&(null===(r=M.current)||void 0===r||null===(a=r.play)||void 0===a||a.call(r)),setTimeout(()=>{var e;return null===(e=F.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth"})},200)}).subscribe();q.current=i}catch(e){g.A.error("No se pudo abrir el chat")}}async function X(e){let a=(e||"").trim();if(a&&k)try{I(!0),await j.from("messages").insert([{chat_id:k.chat_id,sender_id:t.id,content:a}])}finally{I(!1),setTimeout(()=>{var e;return null===(e=F.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth"})},200)}}return(0,s.useEffect)(()=>{(async()=>{try{"undefined"!=typeof Audio&&(M.current=new Audio("/notify.mp3"));let{data:t,error:r}=await j.auth.getUser();if(r)throw r;(null==t?void 0:t.user)?(a(t.user),await w(t.user.id)):e.replace("/login")}catch(t){console.error("Error inicializando sesi\xf3n:",t),g.A.error("Error al obtener usuario o sesi\xf3n expirada"),e.replace("/login")}})()},[e]),(0,s.useEffect)(()=>{if(!(null==t?void 0:t.id))return;let e=t.id;(async function(){try{N(!0);let{data:t,error:a}=await j.from("jobs").select("\n            id, title, description, status, client_id, worker_id,\n            client_lat, client_lng, created_at,\n            client:profiles!client_id(full_name, avatar_url)\n          ").eq("worker_id",e).order("created_at",{ascending:!1});if(a)throw a;v(t||[])}catch(e){console.error("Error cargando trabajos:",e),g.A.error("Error al cargar trabajos")}finally{N(!1)}})();let a=j.channel("jobs-feed").on("postgres_changes",{event:"*",schema:"public",table:"jobs",filter:"worker_id=eq.".concat(e)},e=>{if("INSERT"===e.eventType){var t,a;g.A.success("\uD83D\uDCE6 \xa1Nuevo pedido asignado a ti!"),null===(a=M.current)||void 0===a||null===(t=a.play)||void 0===t||t.call(a),v(t=>[e.new,...t])}"UPDATE"===e.eventType&&v(t=>t.map(t=>t.id===e.new.id?{...t,...e.new}:t))}).subscribe();return()=>{j.removeChannel(a)}},[t]),(0,r.jsxs)(n.E.div,{initial:{opacity:0},animate:{opacity:1},className:"container max-w-screen-md mx-auto px-4 pb-28 bg-white text-gray-900 min-h-screen",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4 pt-6",children:[(0,r.jsx)("h1",{className:"text-lg font-extrabold text-emerald-600",children:"Panel del Trabajador"}),(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsxs)("button",{onClick:Y,className:"flex items-center gap-1 text-sm font-semibold ".concat(T?"text-emerald-600 hover:text-emerald-800":"text-gray-400 hover:text-red-500"," transition"),children:[(0,r.jsx)(o.Z,{size:16})," ",T?"Disponible":"Pausado"]}),(0,r.jsxs)("button",{onClick:()=>e.push("/role-selector"),className:"flex items-center gap-1 text-sm font-semibold text-gray-400 hover:text-emerald-500 transition",children:[(0,r.jsx)(c.Z,{size:16})," Volver al inicio"]})]})]}),_?(0,r.jsxs)("div",{className:"flex justify-center mt-10 text-gray-400",children:[(0,r.jsx)(d.Z,{className:"animate-spin"})," Cargando trabajos..."]}):0===y.length?(0,r.jsx)("p",{className:"text-gray-500 mt-10 text-center",children:"A\xfan no ten\xe9s solicitudes disponibles."}):(0,r.jsx)("section",{className:"grid gap-3 mt-5",children:y.map(e=>{var t,a,s;return(0,r.jsxs)(n.E.div,{whileTap:{scale:.98},className:"border rounded-2xl p-4 transition shadow-sm bg-white hover:shadow-md",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsx)("h3",{className:"font-bold text-gray-800",children:e.title||"Trabajo de Servicio"}),(0,r.jsx)("span",{className:"px-2 py-1 rounded-full text-xs font-semibold ".concat("open"===e.status?"bg-yellow-100 text-yellow-700":"accepted"===e.status?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"),children:"open"===e.status?"Disponible":"accepted"===e.status?"En curso":"Completado"})]}),(0,r.jsx)("p",{className:"text-sm text-gray-600",children:e.description||"Pedido generado desde el mapa"}),e.client&&(0,r.jsxs)("div",{className:"flex items-center gap-2 mt-2",children:[(0,r.jsx)("img",{src:(null===(t=e.client)||void 0===t?void 0:t.avatar_url)||"/avatar-fallback.png",alt:(null===(a=e.client)||void 0===a?void 0:a.full_name)||"Cliente",className:"w-6 h-6 rounded-full border border-gray-200"}),(0,r.jsx)("p",{className:"text-sm text-gray-700 font-medium",children:(null===(s=e.client)||void 0===s?void 0:s.full_name)||"Cliente sin nombre"})]}),"open"===e.status&&(0,r.jsxs)("div",{className:"flex gap-2 mt-3",children:[(0,r.jsx)("button",{onClick:()=>O(e),className:"flex-1 bg-emerald-500 text-white py-2 rounded-xl hover:bg-emerald-600 font-semibold",children:"Aceptar"}),(0,r.jsx)("button",{onClick:()=>P(e),className:"flex-1 bg-gray-200 text-gray-700 py-2 rounded-xl hover:bg-gray-300 font-semibold",children:"Rechazar"})]}),"accepted"===e.status&&(0,r.jsxs)("div",{className:"flex flex-col gap-2 mt-3",children:[(0,r.jsxs)("button",{onClick:()=>window.open("https://www.google.com/maps/dir/?api=1&destination=".concat(e.client_lat,",").concat(e.client_lng),"_blank"),className:"w-full bg-emerald-100 text-emerald-700 py-2 rounded-xl font-semibold hover:bg-emerald-200 transition flex items-center justify-center gap-1",children:[(0,r.jsx)(u.Z,{size:16})," Ver ubicaci\xf3n"]}),(0,r.jsx)("button",{onClick:()=>B(e),className:"w-full bg-gray-100 text-gray-800 py-2 rounded-xl font-semibold hover:bg-gray-200 transition",children:"\uD83D\uDCAC Chat con cliente"}),(0,r.jsxs)("button",{onClick:()=>U(e),className:"w-full bg-emerald-600 text-white py-2 rounded-xl font-semibold hover:bg-emerald-700 transition flex items-center justify-center gap-1",children:[(0,r.jsx)(m.Z,{size:16})," Finalizar trabajo"]})]}),"completed"===e.status&&(0,r.jsx)("div",{className:"mt-3 text-center text-emerald-600 font-medium",children:"✅ Trabajo finalizado"})]},e.id)})}),(0,r.jsx)(l.M,{children:E&&k&&(0,r.jsx)(n.E.div,{className:"fixed inset-0 bg-black/40 flex justify-center items-end z-[80]",children:(0,r.jsxs)(n.E.div,{className:"bg-white rounded-t-3xl w-full max-w-md shadow-xl",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-100 bg-gray-50",children:[(0,r.jsxs)("button",{onClick:()=>D(!1),className:"flex items-center gap-1 text-gray-600 hover:text-red-500",children:[(0,r.jsx)(x.Z,{size:18})," Volver"]}),(0,r.jsx)("h2",{className:"font-semibold text-gray-800",children:"Chat con cliente"}),(0,r.jsxs)("button",{onClick:()=>window.open("https://www.google.com/maps/dir/?api=1&destination=".concat(k.client_lat,",").concat(k.client_lng),"_blank"),className:"flex items-center gap-1 text-emerald-600 hover:text-emerald-800 text-sm font-semibold",children:[(0,r.jsx)(u.Z,{size:16})," Mapa"]})]}),(0,r.jsxs)("div",{className:"flex flex-col h-[70vh] bg-white",children:[(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto px-4 py-3 space-y-2",children:[z.map(e=>{let a=e.sender_id===(null==t?void 0:t.id);return(0,r.jsx)("div",{className:"flex ".concat(a?"justify-end":"justify-start"),children:(0,r.jsxs)("div",{className:"max-w-[80%] px-3 py-2 rounded-2xl text-sm shadow-sm ".concat(a?"bg-emerald-500 text-white":"bg-gray-100 text-gray-800"),children:[e.content,(0,r.jsx)("div",{className:"text-[10px] mt-1 opacity-70 ".concat(a?"text-white":"text-gray-500"),children:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},e.id)}),(0,r.jsx)("div",{ref:F})]}),(0,r.jsxs)("form",{className:"p-3 border-t border-gray-100 flex gap-2",onSubmit:async e=>{var t;e.preventDefault();let a=(null===(t=V.current)||void 0===t?void 0:t.value)||"";await X(a),V.current&&(V.current.value="")},children:[(0,r.jsx)("input",{ref:V,type:"text",placeholder:"Escrib\xed un mensaje…",className:"flex-1 bg-gray-100 rounded-xl px-3 py-3 outline-none focus:ring-2 focus:ring-emerald-400 border border-gray-200"}),(0,r.jsx)("button",{disabled:S,className:"px-4 rounded-xl bg-emerald-500 text-white font-semibold hover:bg-emerald-600 transition disabled:opacity-60",children:(0,r.jsx)(f.Z,{size:18})})]})]})]})})}),(0,r.jsxs)("div",{className:"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 shadow-sm flex justify-around py-2 text-sm font-semibold z-50",children:[(0,r.jsxs)("button",{className:"flex flex-col items-center text-emerald-600",children:[(0,r.jsx)(p.Z,{size:18})," ",(0,r.jsx)("span",{children:"Trabajos"})]}),(0,r.jsxs)("button",{onClick:()=>D(!0),className:"flex flex-col items-center text-gray-500",children:[(0,r.jsx)(h.Z,{size:18})," ",(0,r.jsx)("span",{children:"Chats"})]}),(0,r.jsxs)("button",{onClick:()=>e.push("/worker/onboard"),className:"flex flex-col items-center text-gray-500",children:[(0,r.jsx)(b.Z,{size:18})," ",(0,r.jsx)("span",{children:"Perfil"})]})]})]})}},4667:function(e,t,a){"use strict";a.d(t,{S:function(){return i}});var r=a(951);let s=null;function i(){if(s)return s;let e="https://ydtficoxjuxsoaxtghhj.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkdGZpY294anV4c29heHRnaGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTUwNDIsImV4cCI6MjA3NTY3MTA0Mn0.KBRDCAJYvjpmcXRnYFcuSI8Mn0zYfJzaN0QJo63gzy8";if(!e||!t)throw console.error("❌ Faltan variables de entorno de Supabase."),Error("Variables de entorno Supabase no configuradas.");return s=(0,r.createBrowserClient)(e,t,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}),console.log("✅ Supabase (browser client) inicializado en",e),s}}},function(e){e.O(0,[951,7776,3642,8469,2971,7023,1744],function(){return e(e.s=5910)}),_N_E=e.O()}]);