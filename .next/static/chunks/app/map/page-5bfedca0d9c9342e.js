(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5883],{1165:function(e,t,a){Promise.resolve().then(a.bind(a,2346))},2346:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return G}});var s=a(7437),i=a(2265),n=a(7818);a(966);var r=a(6463),l=a(3763),c=a(5348),o=a(9338),d=a(3622),u=a(3045),x=a(3907),m=a(5575),h=a(5293),f=a(4512),b=a(3765),p=a(1730),g=a(518),j=a(1935),w=a(5193),v=a(6141),y=a(3231),N=a(7091),_=a(4667),k=a(7776),S=a(556);let C=(0,_.S)(),z=(0,n.default)(()=>a.e(9720).then(a.bind(a,9720)).then(e=>e.MapContainer),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),D=(0,n.default)(()=>a.e(9720).then(a.bind(a,9720)).then(e=>e.TileLayer),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),E=(0,n.default)(()=>a.e(9720).then(a.bind(a,9720)).then(e=>e.Marker),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),I=(0,n.default)(()=>a.e(9720).then(a.bind(a,9720)).then(e=>e.Circle),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),A=(0,n.default)(()=>a.e(9720).then(a.bind(a,9720)).then(e=>e.Tooltip),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),Z=(0,n.default)(()=>a.e(5790).then(a.bind(a,5790)).then(e=>e.default),{loadableGenerated:{webpack:()=>[5790]},ssr:!1});function M(e){let{center:t}=e,a=(0,S.Sx)();return(0,i.useEffect)(()=>{a&&t&&a.setView(t)},[t,a]),null}function T(e){let{avg:t=0,count:a=0}=e,i=Math.floor(t),n=t-i>=.5;return(0,s.jsxs)("div",{className:"flex justify-center items-center gap-0.5 mt-1",children:[Array.from({length:i}).map((e,t)=>(0,s.jsx)(o.Z,{size:14,className:"text-yellow-400 fill-yellow-400"},"f".concat(t))),n&&(0,s.jsx)(o.Z,{size:14,className:"text-yellow-400"}),Array.from({length:5-i-(n?1:0)}).map((e,t)=>(0,s.jsx)(o.Z,{size:14,className:"text-gray-300"},"e".concat(t))),(0,s.jsxs)("span",{className:"text-xs text-gray-500 ml-1",children:["(",a,")"]})]})}let J=e=>(e||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");function G(){let e=(0,r.useRouter)(),[t,n]=(0,i.useState)([-25.516,-54.616]),[o,_]=(0,i.useState)({id:null,lat:null,lon:null}),[S,G]=(0,i.useState)([]),[O,R]=(0,i.useState)(!1),[F,Y]=(0,i.useState)(null),[P,q]=(0,i.useState)(!1),[L,U]=(0,i.useState)(null),[V,B]=(0,i.useState)([]),[X,H]=(0,i.useState)(new Set),[Q,K]=(0,i.useState)(null),W=(0,i.useRef)(null),$=(0,i.useRef)(null),ee=[{id:"plomer\xeda",label:"Plomer\xeda",icon:(0,s.jsx)(d.Z,{size:18})},{id:"electricidad",label:"Electricidad",icon:(0,s.jsx)(u.Z,{size:18})},{id:"limpieza",label:"Limpieza",icon:(0,s.jsx)(x.Z,{size:18})},{id:"construcci\xf3n",label:"Construcci\xf3n",icon:(0,s.jsx)(m.Z,{size:18})},{id:"jardiner\xeda",label:"Jardiner\xeda",icon:(0,s.jsx)(h.Z,{size:18})},{id:"mascotas",label:"Mascotas",icon:(0,s.jsx)(f.Z,{size:18})},{id:"emergencia",label:"Emergencia",icon:(0,s.jsx)(b.Z,{size:18})}];async function et(){R(!0);try{let{data:e,error:t}=await C.from("map_workers_view").select("*").not("lat","is",null).not("lng","is",null);if(t)throw t;let a=e;if(Q){let e=J(Q);a=a.filter(t=>(t.skills||[]).some(t=>J(t).includes(e)))}G(a)}catch(e){k.A.error("Error cargando trabajadores: "+e.message)}finally{R(!1)}}async function ea(e){if(!o.id)return k.A.warning("Inici\xe1 sesi\xf3n");if(!X.has(e.user_id))try{var t;H(t=>new Set([...t,e.user_id]));let{error:a}=await C.from("jobs").insert([{status:"open",title:"Trabajo de ".concat((null===(t=e.skills)||void 0===t?void 0:t[0])||"servicio"),worker_id:e.user_id,client_id:o.id,client_lat:o.lat,client_lng:o.lon,created_at:new Date().toISOString()}]).select().single();if(a)throw a;k.A.success("\uD83D\uDE80 Solicitud enviada a ".concat(e.full_name||"el trabajador"))}catch(e){k.A.error("Error al solicitar: "+e.message)}}async function es(e){if(!o.id)return k.A.warning("Inici\xe1 sesi\xf3n");try{let{data:t}=await C.from("chats").select("id").eq("client_id",o.id).eq("worker_id",e.user_id).maybeSingle(),a=null==t?void 0:t.id;if(!a){let{data:t}=await C.from("chats").insert([{client_id:o.id,worker_id:e.user_id}]).select("id").single();a=t.id}U(a),q(!0);let{data:s}=await C.from("messages").select("*").eq("chat_id",a).order("created_at",{ascending:!0});B(s||[]),$.current&&C.removeChannel($.current);let i=C.channel("chat-".concat(a)).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:"chat_id=eq.".concat(a)},e=>B(t=>[...t,e.new])).subscribe();$.current=i}catch(e){k.A.error("No se pudo abrir el chat")}}async function ei(e){let t=e.trim();t&&L&&await C.from("messages").insert([{chat_id:L,sender_id:o.id,content:t}])}return(0,i.useEffect)(()=>{(async()=>{var t;let{data:a}=await C.auth.getUser(),s=null==a?void 0:null===(t=a.user)||void 0===t?void 0:t.id;if(!s)return e.replace("/login");_(e=>({...e,id:s}))})()},[e]),(0,i.useEffect)(()=>{let e;if(!navigator.geolocation){k.A.error("Tu navegador no soporta geolocalizaci\xf3n");return}return(async()=>{var t;let{data:a}=await C.auth.getUser(),s=null==a?void 0:null===(t=a.user)||void 0===t?void 0:t.id;e=navigator.geolocation.watchPosition(async e=>{let t=e.coords.latitude,a=e.coords.longitude;n([t,a]),_({id:s,lat:t,lon:a}),await C.from("worker_profiles").upsert({user_id:s,lat:t,lng:a,updated_at:new Date().toISOString()},{onConflict:"user_id"})},e=>{console.warn("⚠️ Error GPS:",e.message),k.A.warning("No pudimos obtener tu ubicaci\xf3n precisa")},{enableHighAccuracy:!0,timeout:3e4,maximumAge:5e3})})(),()=>e&&navigator.geolocation.clearWatch(e)},[]),(0,i.useEffect)(()=>{let e=C.channel("realtime-workers").on("postgres_changes",{event:"*",schema:"public",table:"worker_profiles"},()=>{et()}).subscribe();return()=>C.removeChannel(e)},[Q]),(0,s.jsxs)(l.E.div,{className:"container max-w-screen-md mx-auto px-4 pb-20 bg-white text-gray-900 min-h-screen",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-4 pt-6",children:[(0,s.jsx)("button",{onClick:()=>e.push("/client"),className:"text-emerald-600 font-semibold flex items-center gap-1",children:"← Atr\xe1s"}),(0,s.jsx)("h1",{className:"text-lg font-bold text-emerald-600",children:"Mapa de servicios"}),(0,s.jsx)("div",{className:"w-8"})]}),(0,s.jsxs)("section",{className:"p-5 bg-white border rounded-2xl shadow-sm text-center",children:[(0,s.jsx)("h2",{className:"font-extrabold text-2xl mb-3",children:"⚡ \xbfQu\xe9 necesit\xe1s hoy?"}),(0,s.jsx)("div",{className:"flex flex-wrap justify-center gap-2 mb-4",children:ee.map(e=>(0,s.jsxs)(l.E.button,{whileTap:{scale:.95},onClick:()=>K(e.id===Q?null:e.id),className:"flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium transition-all border ".concat(Q===e.id?"bg-emerald-500 text-white border-emerald-500 shadow-sm":"bg-gray-50 text-gray-700 border-gray-200 hover:bg-gray-100"),children:[e.icon,e.label]},e.id))}),(0,s.jsx)(l.E.button,{whileTap:{scale:.97},onClick:et,className:"mt-2 w-full py-3 text-lg font-semibold rounded-xl bg-emerald-500 text-white shadow hover:bg-emerald-600",children:O?"Buscando…":"\uD83C\uDF0D Mostrar en mapa"})]}),(0,s.jsxs)("div",{className:"mt-5 rounded-2xl overflow-hidden border shadow bg-gray-50 relative",style:{height:"65vh"},children:[(0,s.jsxs)(z,{center:t,zoom:13,style:{height:"100%",width:"100%"},children:[(0,s.jsx)(M,{center:t}),(0,s.jsx)(D,{url:"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"}),o.lat&&o.lon&&(0,s.jsx)(I,{center:[o.lat,o.lon],radius:60,pathOptions:{color:"#10b981",fillOpacity:.15},children:(0,s.jsx)(A,{children:"\uD83D\uDCCD Mi ubicaci\xf3n"})}),(0,s.jsx)(Z,{chunkedLoading:!0,maxClusterRadius:48,iconCreateFunction:function(e){let t=a(7691),s=e.getChildCount();return t.divIcon({html:'<div class="flex items-center justify-center w-10 h-10 bg-emerald-500 text-white font-bold rounded-full shadow">'.concat(s,"</div>"),className:""})},children:S.map(e=>(0,s.jsx)(E,{position:[e.lat,e.lng],icon:function(e,t){let s=a(7691),i=(Date.now()-new Date((null==t?void 0:t.updated_at)||Date.now()).getTime())/6e4<=30?"#10b981":"#9ca3af",n='\n    <div style="width:'.concat(52,"px;height:").concat(52,'px;border-radius:50%;\n      position:relative;background:#fff;overflow:hidden;\n      box-shadow:0 4px 10px rgba(0,0,0,.2);">\n      <div style="position:absolute;inset:-4px;border-radius:50%;\n        border:3px solid ').concat(i,";\n        filter:drop-shadow(0 0 6px ").concat(i,'40);"></div>\n      <img src="').concat(e||"/avatar-fallback.png",'"\n           style="position:absolute;inset:0;width:100%;height:100%;\n           object-fit:cover;border-radius:50%;" />\n    </div>');return s.divIcon({html:n,iconSize:[52,52],className:""})}(e.avatar_url,e),eventHandlers:{click:()=>Y(e)}},e.user_id))})]}),(0,s.jsx)("button",{onClick:function(){o.lat&&o.lon&&n([o.lat,o.lon])},className:"absolute bottom-5 right-5 bg-white p-3 rounded-full shadow border hover:bg-gray-50",children:(0,s.jsx)(p.Z,{className:"text-emerald-600",size:22})})]}),(0,s.jsx)(c.M,{children:F&&(0,s.jsx)(l.E.div,{className:"fixed inset-0 bg-black/40 flex items-end justify-center z-[9999]",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:(0,s.jsxs)(l.E.div,{className:"bg-white rounded-t-3xl w-full max-w-md shadow-2xl text-center overflow-y-auto max-h-[88vh]",initial:{y:50},animate:{y:0},exit:{y:50},children:[(0,s.jsxs)("div",{className:"flex justify-between items-center px-5 py-4 border-b sticky top-0 bg-white",children:[P?(0,s.jsxs)("button",{onClick:()=>q(!1),className:"flex items-center gap-1 text-gray-600",children:[(0,s.jsx)(g.Z,{size:20})," Perfil"]}):(0,s.jsx)("div",{className:"w-6"}),(0,s.jsx)("div",{className:"font-semibold",children:P?"Chat con ".concat(F.full_name||"Trabajador"):"Perfil"}),(0,s.jsx)("button",{onClick:()=>Y(null),children:(0,s.jsx)(j.Z,{size:22,className:"text-gray-400 hover:text-red-400"})})]}),P?(0,s.jsxs)("div",{className:"flex flex-col h-[70vh]",children:[(0,s.jsx)("div",{className:"flex-1 overflow-y-auto px-4 py-3 space-y-2",children:V.map(e=>{let t=e.sender_id===o.id;return(0,s.jsx)("div",{className:"flex ".concat(t?"justify-end":"justify-start"),children:(0,s.jsx)("div",{className:"max-w-[80%] px-3 py-2 rounded-2xl text-sm shadow-sm ".concat(t?"bg-emerald-500 text-white":"bg-gray-100 text-gray-800"),children:e.content})},e.id)})}),(0,s.jsxs)("form",{className:"p-3 border-t flex gap-2",onSubmit:async e=>{var t;e.preventDefault();let a=(null===(t=W.current)||void 0===t?void 0:t.value)||"";await ei(a),W.current&&(W.current.value="")},children:[(0,s.jsx)("input",{ref:W,type:"text",placeholder:"Escrib\xed un mensaje…",className:"flex-1 bg-gray-100 rounded-xl px-3 py-3 border"}),(0,s.jsx)("button",{className:"px-4 bg-emerald-500 text-white rounded-xl",children:(0,s.jsx)(N.Z,{size:18})})]})]}):(0,s.jsxs)("div",{className:"px-6 pb-8 pt-4",children:[(0,s.jsx)("img",{src:F.avatar_url||"/avatar-fallback.png",alt:F.full_name||"Trabajador",className:"w-24 h-24 rounded-full mx-auto mb-3 border-4 border-emerald-500 object-cover"}),(0,s.jsx)("h3",{className:"text-xl font-bold capitalize",children:F.full_name||"Trabajador"}),(0,s.jsx)(T,{avg:F.rating_avg||0,count:F.rating_count||0}),(0,s.jsxs)("p",{className:"text-sm italic text-gray-600 mt-2",children:["“",F.bio||"Sin descripci\xf3n.","”"]}),(0,s.jsxs)("div",{className:"mt-4 flex flex-col gap-2 items-center",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 text-gray-700 text-sm",children:[(0,s.jsx)(w.Z,{className:"text-emerald-500",size:16}),(0,s.jsx)("span",{children:"number"==typeof F.years_experience&&F.years_experience>0?"".concat(F.years_experience," a\xf1os de experiencia"):"Sin experiencia especificada"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full text-xs font-semibold",children:[(0,s.jsx)(v.Z,{size:14})," Frecuente en tu zona"]}),(0,s.jsx)("p",{className:"text-xs text-emerald-600 mt-1",children:function(e,t){if(!e)return"Sin datos";if("working"===t)return"En trabajo";let a=Math.floor((Date.now()-new Date(e).getTime())/6e4);if(a<1)return"Activo hace segundos";if(a<60)return"Activo hace ".concat(a," min");let s=Math.floor(a/60);if(s<24)return"Activo hace ".concat(s,"h");let i=Math.floor(s/24);return"Activo hace ".concat(i," d\xeda").concat(i>1?"s":"")}(F.updated_at,F.status)})]}),(0,s.jsx)("div",{className:"mt-4 text-left space-y-2",children:(0,s.jsxs)("div",{className:"bg-gray-50 border rounded-xl p-3",children:[(0,s.jsx)("p",{className:"text-xs text-gray-500",children:"Especialidades"}),(0,s.jsx)("p",{className:"text-sm",children:(F.skills||[]).length?(F.skills||[]).join(", "):"Sin especialidades registradas"})]})}),X.has(F.user_id)?(0,s.jsxs)("div",{className:"mt-5 bg-gray-50 border rounded-xl p-3",children:[(0,s.jsx)(y.Z,{className:"text-emerald-500 mx-auto"}),(0,s.jsx)("p",{className:"text-emerald-600 font-semibold",children:"Solicitud enviada"})]}):(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-3 mt-5",children:[(0,s.jsx)("button",{onClick:()=>es(F),className:"py-3 border rounded-xl",children:"\uD83D\uDCAC Chatear"}),(0,s.jsx)("button",{onClick:()=>ea(F),className:"py-3 rounded-xl bg-emerald-500 text-white font-semibold hover:bg-emerald-600",children:"\uD83D\uDE80 Solicitar"})]})]})]})})})]})}},4667:function(e,t,a){"use strict";a.d(t,{S:function(){return n}});var s=a(951);let i=null;function n(){if(i)return i;let e="https://ydtficoxjuxsoaxtghhj.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkdGZpY294anV4c29heHRnaGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTUwNDIsImV4cCI6MjA3NTY3MTA0Mn0.KBRDCAJYvjpmcXRnYFcuSI8Mn0zYfJzaN0QJo63gzy8";if(!e||!t)throw console.error("❌ Faltan variables de entorno de Supabase."),Error("Variables de entorno Supabase no configuradas.");return i=(0,s.createBrowserClient)(e,t,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}),console.log("✅ Supabase (browser client) inicializado en",e),i}}},function(e){e.O(0,[2733,4212,951,7776,3642,6877,2971,7023,1744],function(){return e(e.s=1165)}),_N_E=e.O()}]);