(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9211],{6374:function(e,t,a){Promise.resolve().then(a.bind(a,1731))},1731:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return l}});var n=a(7437),s=a(2265),r=a(6463),i=a(4667);function l(){let{id:e}=(0,r.useParams)(),t=(0,r.useRouter)(),[a,l]=(0,s.useState)(null),[c,u]=(0,s.useState)(null),[o,d]=(0,s.useState)([]),[m,f]=(0,s.useState)(""),[h,v]=(0,s.useState)(!0),[b,p]=(0,s.useState)(null),x=(0,s.useRef)(null);async function g(t){var n;null==t||null===(n=t.preventDefault)||void 0===n||n.call(t);let s=m.trim();if(!s||!a)return;f("");let r={sender:a.id,receiver:e,content:s},{error:l}=await i.supabase.from("dm_messages").insert(r);l&&(f(s),alert(l.message))}return((0,s.useEffect)(()=>{i.supabase.auth.getUser().then(e=>{var t;let{data:a}=e;return l(null!==(t=null==a?void 0:a.user)&&void 0!==t?t:null)});let{data:e}=i.supabase.auth.onAuthStateChange((e,t)=>{var a;return l(null!==(a=null==t?void 0:t.user)&&void 0!==a?a:null)});return()=>e.subscription.unsubscribe()},[]),(0,s.useEffect)(()=>{e&&(async()=>{try{v(!0),p(null);let{data:t}=await i.supabase.from("profiles").select("id, full_name, avatar_url").eq("id",e).maybeSingle();u(t);let{data:n,error:s}=await i.supabase.from("dm_messages").select("*").or("sender.eq.".concat(null==a?void 0:a.id,",receiver.eq.").concat(null==a?void 0:a.id)).or("sender.eq.".concat(e,",receiver.eq.").concat(e)).order("created_at",{ascending:!0});if(s)throw s;d(n||[])}catch(e){p(e.message||String(e))}finally{v(!1)}})()},[e,null==a?void 0:a.id]),(0,s.useEffect)(()=>{if(!e||!a)return;let t=i.supabase.channel("dm_".concat(a.id,"_").concat(e)).on("postgres_changes",{event:"INSERT",schema:"public",table:"dm_messages"},t=>{let n=t.new;(n.sender===a.id&&n.receiver===e||n.sender===e&&n.receiver===a.id)&&(d(e=>[...e,n]),setTimeout(()=>{var e;return null===(e=x.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth"})},50))}).subscribe();return()=>i.supabase.removeChannel(t)},[a,e]),h)?(0,n.jsx)("div",{className:"container p-5",children:"Cargando chat…"}):b?(0,n.jsxs)("div",{className:"container p-5 text-red-400",children:["Error: ",b]}):(0,n.jsxs)("div",{className:"container",children:[(0,n.jsxs)("section",{className:"card p-4 mt-6 flex items-center gap-3",children:[(0,n.jsx)("button",{className:"btn btn-ghost",onClick:()=>t.back(),children:"← Volver"}),c&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("img",{src:c.avatar_url||"/avatar-fallback.png",alt:"",style:{width:40,height:40,borderRadius:"50%",objectFit:"cover",border:"2px solid var(--accent)"}}),(0,n.jsx)("div",{className:"text-white/90 font-semibold",children:c.full_name})]})]}),(0,n.jsx)("section",{className:"card p-4 mt-4",style:{minHeight:420},children:(0,n.jsxs)("div",{className:"flex flex-col gap-2",children:[o.map(e=>{let t=e.sender===(null==a?void 0:a.id);return(0,n.jsx)("div",{className:"flex ".concat(t?"justify-end":"justify-start"),children:(0,n.jsx)("div",{className:"px-3 py-2 rounded-2xl text-sm max-w-[78%]",style:{background:t?"var(--accent)":"rgba(255,255,255,0.08)",color:t?"#0B0D0F":"#fff"},title:new Date(e.created_at).toLocaleString(),children:e.content})},e.id)}),(0,n.jsx)("div",{ref:x})]})}),(0,n.jsx)("section",{className:"card p-3 mt-3",children:(0,n.jsxs)("form",{onSubmit:g,className:"flex gap-2",children:[(0,n.jsx)("input",{className:"input",placeholder:"Escrib\xed un mensaje…",value:m,onChange:e=>f(e.target.value)}),(0,n.jsx)("button",{className:"btn btn-primary",type:"submit",children:"Enviar"})]})})]})}},4667:function(e,t,a){"use strict";a.d(t,{S:function(){return r}});var n=a(951);let s=null;function r(){if(s)return s;let e="https://ydtficoxjuxsoaxtghhj.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkdGZpY294anV4c29heHRnaGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTUwNDIsImV4cCI6MjA3NTY3MTA0Mn0.KBRDCAJYvjpmcXRnYFcuSI8Mn0zYfJzaN0QJo63gzy8";if(!e||!t)throw console.error("❌ Faltan variables de entorno de Supabase."),Error("Variables de entorno Supabase no configuradas.");return s=(0,n.createBrowserClient)(e,t,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}),console.log("✅ Supabase (browser client) inicializado en",e),s}},6463:function(e,t,a){"use strict";var n=a(1169);a.o(n,"useParams")&&a.d(t,{useParams:function(){return n.useParams}}),a.o(n,"usePathname")&&a.d(t,{usePathname:function(){return n.usePathname}}),a.o(n,"useRouter")&&a.d(t,{useRouter:function(){return n.useRouter}})}},function(e){e.O(0,[951,2971,7023,1744],function(){return e(e.s=6374)}),_N_E=e.O()}]);