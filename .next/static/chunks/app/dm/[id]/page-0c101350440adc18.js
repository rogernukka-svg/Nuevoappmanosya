(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9301],{1937:function(e,a,n){Promise.resolve().then(n.bind(n,308))},308:function(e,a,n){"use strict";n.r(a),n.d(a,{default:function(){return d}});var t=n(7437),s=n(2265),r=n(6463),i=n(4667),c=n(3763),o=n(8030);let l=(0,o.Z)("map-pin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]),u=(0,o.Z)("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);function d(){let{id:e}=(0,r.useParams)(),[a,n]=(0,s.useState)([]),[o,d]=(0,s.useState)(""),[m,b]=(0,s.useState)(null),[h,p]=(0,s.useState)(null),[f,g]=(0,s.useState)(0);async function x(){if(!m||!e)return;let{data:a,error:t}=await i.supabase.from("dm_messages").select("*").or("and(sender_id.eq.".concat(m.id,",receiver_id.eq.").concat(e,"),and(sender_id.eq.").concat(e,",receiver_id.eq.").concat(m.id,")")).order("created_at",{ascending:!0});t||n(a||[])}async function v(e){let{count:a}=await i.supabase.from("jobs").select("id",{count:"exact",head:!0}).eq("worker_id",e).eq("status","completed");g(a||0)}async function w(a){a.trim()&&m&&e&&await i.supabase.from("dm_messages").insert({sender_id:m.id,receiver_id:e,content:a})}async function _(){if(!navigator.geolocation)return alert("Tu dispositivo no soporta geolocalizaci\xf3n");navigator.geolocation.getCurrentPosition(async a=>{let{latitude:n,longitude:t}=a.coords;await i.supabase.from("dm_messages").insert({sender_id:m.id,receiver_id:e,content:"\uD83D\uDCCD Ubicaci\xf3n compartida",lat:n,lng:t})})}async function j(){await w("\uD83D\uDE96 El trabajador ha llegado al destino")}async function y(){await w("✅ Trabajo finalizado"),m&&v(m.id)}return(0,s.useEffect)(()=>{i.supabase.auth.getUser().then(e=>{var a;let{data:n}=e;b(null!==(a=null==n?void 0:n.user)&&void 0!==a?a:null),(null==n?void 0:n.user)&&v(n.user.id)})},[]),(0,s.useEffect)(()=>{if(!m||!e)return;x();let a=i.supabase.channel("dm-messages-channel").on("postgres_changes",{event:"INSERT",schema:"public",table:"dm_messages"},a=>{let t=a.new;(t.sender_id===m.id&&t.receiver_id===e||t.sender_id===e&&t.receiver_id===m.id)&&n(e=>[...e,t])}).subscribe();return()=>{i.supabase.removeChannel(a)}},[m,e]),(0,t.jsxs)("div",{className:"container max-w-lg mx-auto p-4",children:[(0,t.jsx)("h1",{className:"text-xl font-bold mb-4",children:"Chat"}),(0,t.jsxs)("div",{className:"mb-3 bg-emerald-600/20 border border-emerald-400/40 rounded-lg p-2 text-emerald-300 text-sm text-center",children:["✅ Trabajos completados: ",f]}),(0,t.jsx)("div",{className:"border border-white/10 rounded-lg p-3 h-[60vh] overflow-y-auto bg-black/40",children:a.map(e=>(0,t.jsx)("div",{className:"my-2 p-2 rounded-lg w-fit max-w-[70%] ".concat(e.sender_id===(null==m?void 0:m.id)?"bg-emerald-600 ml-auto":"bg-zinc-700 mr-auto"),children:e.lat&&e.lng?(0,t.jsx)("a",{href:"https://www.google.com/maps?q=".concat(e.lat,",").concat(e.lng),target:"_blank",rel:"noreferrer",className:"underline text-blue-200",children:"\uD83D\uDCCD Ver ubicaci\xf3n en Google Maps"}):e.content},e.id))}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mt-3",children:[(0,t.jsx)("input",{type:"text",value:o,onChange:e=>d(e.target.value),className:"flex-1 rounded-lg px-3 py-2 bg-zinc-800 border border-white/10",placeholder:"Escrib\xed un mensaje..."}),(0,t.jsx)("button",{onClick:()=>w(o),className:"btn btn-primary",children:"Enviar"}),(0,t.jsx)(c.E.button,{whileTap:{scale:.85},onClick:_,className:"p-2 rounded-full bg-pink-600 text-white",children:(0,t.jsx)(l,{size:20})}),(0,t.jsx)(c.E.button,{whileTap:{scale:.85},onClick:j,className:"p-2 rounded-full bg-green-600 text-white",children:"\uD83D\uDE96"}),(0,t.jsx)(c.E.button,{whileTap:{scale:.85},onClick:y,className:"p-2 rounded-full bg-blue-600 text-white",children:(0,t.jsx)(u,{size:20})})]})]})}},4667:function(e,a,n){"use strict";n.d(a,{S:function(){return r}});var t=n(951);let s=null;function r(){if(s)return s;let e="https://ydtficoxjuxsoaxtghhj.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkdGZpY294anV4c29heHRnaGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTUwNDIsImV4cCI6MjA3NTY3MTA0Mn0.KBRDCAJYvjpmcXRnYFcuSI8Mn0zYfJzaN0QJo63gzy8";if(!e||!a)throw console.error("❌ Faltan variables de entorno de Supabase."),Error("Variables de entorno Supabase no configuradas.");return s=(0,t.createBrowserClient)(e,a,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}),console.log("✅ Supabase (browser client) inicializado en",e),s}},6463:function(e,a,n){"use strict";var t=n(1169);n.o(t,"useParams")&&n.d(a,{useParams:function(){return t.useParams}}),n.o(t,"usePathname")&&n.d(a,{usePathname:function(){return t.usePathname}}),n.o(t,"useRouter")&&n.d(a,{useRouter:function(){return t.useRouter}})}},function(e){e.O(0,[951,3642,2971,7023,1744],function(){return e(e.s=1937)}),_N_E=e.O()}]);