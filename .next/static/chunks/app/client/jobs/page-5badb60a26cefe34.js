(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9876],{9215:function(e,t,a){Promise.resolve().then(a.bind(a,4245))},4245:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return v}});var r=a(7437),s=a(2265),i=a(4667),n=a(3763),l=a(5348),o=a(4232),c=a(3274),d=a(3193),u=a(6706),m=a(9338),x=a(3231),h=a(7390),f=a(518),g=a(7091),p=a(7776);let b=(0,i.S)();function v(){var e;let[t,a]=(0,s.useState)(null),[i,v]=(0,s.useState)([]),[y,j]=(0,s.useState)(!0),[w,N]=(0,s.useState)([]),[_,C]=(0,s.useState)(!1),[D,k]=(0,s.useState)(null),[S,E]=(0,s.useState)(!1),I=(0,s.useRef)(null),A=(0,s.useRef)(null),z=(0,s.useRef)(null),R=(0,s.useRef)(null),[Z,J]=(0,s.useState)(!1),[F,T]=(0,s.useState)(0),[M,V]=(0,s.useState)("");async function Y(){if(!(null==t?void 0:t.id))return;j(!0);let{data:e,error:a}=await b.from("jobs").select("\n        *,\n        worker:profiles!worker_id(full_name, avatar_url),\n        review:reviews!job_id(rating, comment, created_at)\n      ").eq("client_id",t.id).order("created_at",{ascending:!1});a?(console.error("❌ Error cargando pedidos:",a),p.A.error("Error al cargar pedidos")):v(e||[]),j(!1)}async function O(e){try{if(!(null==e?void 0:e.worker_id))return(0,p.A)("⚠️ A\xfan no tiene trabajador asignado");let{data:a,error:r}=await b.rpc("ensure_chat_for_job",{p_job_id:e.id});if(r)throw r;let{data:s}=await b.from("messages").select("*").eq("chat_id",a).order("created_at",{ascending:!0});N(s||[]),k({...e,chat_id:a}),C(!0),A.current&&b.removeChannel(A.current);let i=b.channel("chat-".concat(a),{config:{broadcast:{self:!0},presence:{key:t.id}}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:"chat_id=eq.".concat(a)},e=>{if(N(t=>[...t,e.new]),e.new.sender_id!==t.id){var a,r;null===(r=R.current)||void 0===r||null===(a=r.play)||void 0===a||a.call(r)}setTimeout(()=>{var e;return null===(e=z.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth"})},200)}).subscribe(async e=>{"SUBSCRIBED"===e&&console.log("✅ Realtime conectado al chat ".concat(a))});A.current=i}catch(e){console.error("❌ Error abriendo chat:",e),p.A.error("No se pudo abrir el chat")}}async function B(e){let a=(e||"").trim();if(a&&(null==t?void 0:t.id)&&D)try{E(!0);let{error:e}=await b.from("messages").insert([{chat_id:D.chat_id,sender_id:t.id,content:a}]);if(e)throw e}catch(e){p.A.error("No se pudo enviar el mensaje")}finally{E(!1),setTimeout(()=>{var e;return null===(e=z.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth"})},200)}}async function U(e,a){if(!F)return(0,p.A)("Seleccion\xe1 una calificaci\xf3n");try{let{error:r}=await b.rpc("add_review_if_valid",{p_job_id:e,p_worker_id:a,p_client_id:t.id,p_rating:F,p_comment:M});if(r)throw r;p.A.success("✅ Calificaci\xf3n enviada"),J(!1),T(0),V(""),await Y()}catch(e){console.error("❌ Error RPC:",e),p.A.error("Error enviando review")}}async function q(e){try{let{error:t}=await b.rpc("reassign_worker_if_needed",{p_job_id:e});if(t)throw t;p.A.success("\uD83D\uDD04 Trabajador reasignado correctamente"),await Y()}catch(e){p.A.error("No se pudo reasignar autom\xe1ticamente")}}return(0,s.useEffect)(()=>(b.auth.getUser().then(e=>{let{data:t}=e;(null==t?void 0:t.user)&&(a(t.user),"undefined"!=typeof Audio&&(R.current=new Audio("/notify.mp3")))}),()=>{A.current&&b.removeChannel(A.current)}),[]),(0,s.useEffect)(()=>{(null==t?void 0:t.id)&&Y()},[t]),(0,r.jsxs)(n.E.div,{initial:{opacity:0},animate:{opacity:1},className:"container max-w-screen-md mx-auto px-4 pb-32 bg-white text-gray-900 min-h-screen relative",children:[(0,r.jsxs)("h1",{className:"text-2xl font-extrabold text-emerald-600 pt-8 mb-4 flex items-center gap-2",children:[(0,r.jsx)(o.Z,{className:"text-emerald-600"})," Panel de Pedidos"]}),(0,r.jsx)("p",{className:"text-gray-500 text-sm mb-4",children:"Gestion\xe1 tus servicios activos, completados y planificados f\xe1cilmente ⚡"}),y?(0,r.jsxs)("div",{className:"flex justify-center mt-10 text-gray-400 gap-2 items-center",children:[(0,r.jsx)(c.Z,{className:"animate-spin"})," Cargando tus pedidos..."]}):0===i.length?(0,r.jsx)("p",{className:"text-center text-gray-500 mt-10",children:"No ten\xe9s pedidos a\xfan. \xa1Comenz\xe1 solicitando tu primer servicio! \uD83D\uDCAA"}):(0,r.jsx)("section",{className:"grid gap-4 mt-5",children:i.map(e=>{var t;let a=null===(t=e.review)||void 0===t?void 0:t[0];return(0,r.jsxs)(n.E.div,{whileHover:{scale:1.01},className:"border rounded-2xl p-5 shadow-sm bg-white hover:shadow-md transition relative",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between mb-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-bold text-gray-800",children:e.title}),(0,r.jsx)("p",{className:"text-sm text-gray-600 line-clamp-2",children:e.description}),(0,r.jsxs)("p",{className:"text-xs text-emerald-600 font-medium mt-1",children:[(0,r.jsx)(d.Z,{className:"inline w-3 h-3 mr-1"}),new Date(e.created_at).toLocaleDateString()]})]}),(0,r.jsx)("span",{className:"text-xs px-2 py-1 rounded-lg font-semibold ".concat("completed"===e.status?"bg-green-100 text-green-700":"cancelled"===e.status?"bg-red-100 text-red-600":"assigned"===e.status?"bg-blue-100 text-blue-700":"bg-emerald-50 text-emerald-700"),children:e.status})]}),e.worker&&(0,r.jsxs)("p",{className:"mt-1 text-sm text-gray-500",children:["\uD83D\uDC77 ",e.worker.full_name||"Asignado autom\xe1ticamente"]}),"assigned"===e.status&&(0,r.jsxs)("button",{onClick:()=>q(e.id),className:"flex items-center gap-2 mt-2 text-sm text-emerald-600 font-medium hover:text-emerald-700 transition",children:[(0,r.jsx)(u.Z,{size:14})," Reasignar trabajador autom\xe1ticamente"]}),a?(0,r.jsxs)("div",{className:"mt-3 p-3 bg-emerald-50 rounded-xl text-sm border border-emerald-100",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1 mb-1",children:[[...Array(a.rating)].map((e,t)=>(0,r.jsx)(m.Z,{className:"w-4 h-4 text-yellow-400 fill-yellow-400"},t)),(0,r.jsx)(x.Z,{className:"w-4 h-4 text-emerald-500 ml-1"})]}),(0,r.jsxs)("p",{className:"italic text-gray-600",children:['"',a.comment,'"']}),(0,r.jsxs)("p",{className:"text-xs text-gray-400 mt-1",children:["Calificado el ",new Date(a.created_at).toLocaleDateString()]})]}):"completed"===e.status&&(0,r.jsx)("button",{onClick:()=>{k(e),J(!0)},className:"mt-3 w-full py-2 rounded-xl bg-emerald-500 text-white font-semibold hover:bg-emerald-600 transition",children:"\uD83C\uDF1F Calificar servicio"}),e.worker_id&&(0,r.jsxs)("button",{onClick:()=>O(e),className:"flex items-center justify-center gap-2 w-full mt-3 bg-gray-100 text-gray-800 py-2 rounded-xl font-semibold hover:bg-gray-200 transition",children:[(0,r.jsx)(h.Z,{size:18})," Chat con trabajador"]})]},e.id)})}),(0,r.jsx)(l.M,{children:_&&(0,r.jsx)(n.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-[99999] flex justify-center items-end bg-black/70",children:(0,r.jsxs)(n.E.div,{initial:{y:300},animate:{y:0},exit:{y:300},transition:{type:"spring",stiffness:120},className:"bg-white w-full max-w-md rounded-t-3xl shadow-2xl flex flex-col",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 bg-gray-50",children:[(0,r.jsxs)("button",{onClick:function(){C(!1),A.current&&(b.removeChannel(A.current),A.current=null)},className:"flex items-center gap-1 text-gray-600 hover:text-red-500",children:[(0,r.jsx)(f.Z,{size:18})," Volver"]}),(0,r.jsx)("h2",{className:"font-semibold text-gray-800",children:"Chat en vivo \uD83D\uDCAC"}),(0,r.jsx)("div",{className:"w-6"})]}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto px-4 py-3 space-y-2 bg-white",children:[0===w.length?(0,r.jsx)("p",{className:"text-center text-gray-400 mt-6",children:"No hay mensajes a\xfan \uD83D\uDCED"}):w.map(e=>{let a=e.sender_id===(null==t?void 0:t.id);return(0,r.jsx)("div",{className:"flex ".concat(a?"justify-end":"justify-start"),children:(0,r.jsx)("div",{className:"max-w-[80%] px-3 py-2 rounded-2xl text-sm shadow-sm ".concat(a?"bg-emerald-500 text-white":"bg-gray-100 text-gray-800"),children:e.content})},e.id)}),(0,r.jsx)("div",{ref:z})]}),(0,r.jsxs)("form",{onSubmit:async e=>{var t;e.preventDefault();let a=(null===(t=I.current)||void 0===t?void 0:t.value)||"";await B(a),I.current&&(I.current.value="")},className:"flex gap-2 p-3 border-t border-gray-100 bg-gray-50",children:[(0,r.jsx)("input",{ref:I,type:"text",placeholder:"Escrib\xed un mensaje…",className:"flex-1 bg-gray-100 rounded-xl px-3 py-3 outline-none focus:ring-2 focus:ring-emerald-400 border border-gray-200"}),(0,r.jsx)("button",{disabled:S,className:"px-4 rounded-xl bg-emerald-500 text-white hover:bg-emerald-600 transition disabled:opacity-60",children:(0,r.jsx)(g.Z,{size:18})})]})]})})}),(0,r.jsx)(l.M,{children:Z&&D&&(0,r.jsx)(n.E.div,{className:"fixed inset-0 bg-black/60 flex justify-center items-center z-[99999]",initial:{opacity:0},animate:{opacity:1},children:(0,r.jsxs)(n.E.div,{className:"bg-white rounded-2xl shadow-2xl p-6 w-[90%] max-w-md text-center",initial:{scale:.9},animate:{scale:1},children:[(0,r.jsxs)("h2",{className:"text-lg font-bold text-gray-800 mb-4",children:["\uD83C\uDF1F \xbfC\xf3mo fue el servicio de ",null===(e=D.worker)||void 0===e?void 0:e.full_name,"?"]}),(0,r.jsx)("div",{className:"flex justify-center gap-2 mb-4",children:[1,2,3,4,5].map(e=>(0,r.jsx)(m.Z,{onClick:()=>T(e),className:"w-8 h-8 cursor-pointer transition ".concat(e<=F?"text-yellow-400 fill-yellow-400 scale-110":"text-gray-300 hover:text-yellow-300")},e))}),(0,r.jsx)("textarea",{value:M,onChange:e=>V(e.target.value),placeholder:"Dej\xe1 un comentario (opcional)",className:"w-full border border-gray-300 rounded-xl p-3 text-sm focus:ring-2 focus:ring-emerald-400 outline-none"}),(0,r.jsxs)("div",{className:"flex gap-3 mt-5",children:[(0,r.jsx)("button",{onClick:()=>J(!1),className:"flex-1 bg-gray-200 text-gray-700 rounded-xl py-2 font-semibold hover:bg-gray-300",children:"Cancelar"}),(0,r.jsx)("button",{onClick:()=>U(D.id,D.worker_id),className:"flex-1 bg-emerald-500 text-white rounded-xl py-2 font-semibold hover:bg-emerald-600",children:"Enviar"})]})]})})})]})}},4667:function(e,t,a){"use strict";a.d(t,{S:function(){return i}});var r=a(951);let s=null;function i(){if(s)return s;let e="https://ydtficoxjuxsoaxtghhj.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkdGZpY294anV4c29heHRnaGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTUwNDIsImV4cCI6MjA3NTY3MTA0Mn0.KBRDCAJYvjpmcXRnYFcuSI8Mn0zYfJzaN0QJo63gzy8";if(!e||!t)throw console.error("❌ Faltan variables de entorno de Supabase."),Error("Variables de entorno Supabase no configuradas.");return s=(0,r.createBrowserClient)(e,t,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}),console.log("✅ Supabase (browser client) inicializado en",e),s}}},function(e){e.O(0,[951,7776,3642,5684,2971,7023,1744],function(){return e(e.s=9215)}),_N_E=e.O()}]);