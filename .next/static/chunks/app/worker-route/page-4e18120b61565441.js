(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5545],{6516:function(e,t,n){Promise.resolve().then(n.bind(n,4057))},4057:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return b}});var l=n(7437),r=n(2265),a=n(7818);n(966);var o=n(4667),i=n(357);let s=(0,a.default)(()=>Promise.all([n.e(9720),n.e(556)]).then(n.bind(n,9720)).then(e=>e.MapContainer),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),u=(0,a.default)(()=>Promise.all([n.e(9720),n.e(556)]).then(n.bind(n,9720)).then(e=>e.TileLayer),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),c=(0,a.default)(()=>Promise.all([n.e(9720),n.e(556)]).then(n.bind(n,9720)).then(e=>e.Marker),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),d=(0,a.default)(()=>Promise.all([n.e(9720),n.e(556)]).then(n.bind(n,9720)).then(e=>e.Polyline),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),f=(0,a.default)(()=>Promise.all([n.e(9720),n.e(556)]).then(n.bind(n,9720)).then(e=>e.Tooltip),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),h=i.env.NEXT_PUBLIC_ORS_API_KEY;function p(e){return n(7691).divIcon({html:'<div style="width:40px;height:40px;border-radius:50%;overflow:hidden;border:2px solid #14B8A6">\n             <img src="'.concat(e||"/avatar-fallback.png",'" style="width:100%;height:100%;object-fit:cover"/>\n           </div>'),className:"",iconSize:[40,40]})}function b(e){let{jobId:t}=e,[n,a]=(0,r.useState)(null),[i,b]=(0,r.useState)(null),[g,m]=(0,r.useState)([]),[x,j]=(0,r.useState)(null),[y,w]=(0,r.useState)(null),[v,_]=(0,r.useState)(!1);async function I(e,t){try{let n=await fetch("https://api.openrouteservice.org/v2/directions/driving-car?api_key=".concat(h,"&start=").concat(e.lng,",").concat(e.lat,"&end=").concat(t.lng,",").concat(t.lat)),l=await n.json(),r=l.features[0].geometry.coordinates.map(e=>[e[1],e[0]]);m(r);let a=l.features[0].properties.segments[0].distance,o=l.features[0].properties.segments[0].duration;w((a/1e3).toFixed(1)),j(Math.round(o/60))}catch(e){console.error("Error ruta ORS:",e)}}async function P(){if(_(!0),alert("Has marcado que llegaste al cliente \uD83D\uDE80"),t){let{error:e}=await o.supabase.from("jobs").update({status:"arrived"}).eq("id",t);e&&console.error("Error actualizando job:",e)}}return(0,r.useEffect)(()=>{(async function(){if(!t)return;let{data:e,error:n}=await o.supabase.from("jobs").select("\n          id,\n          status,\n          client_lat,\n          client_lng,\n          worker_id\n        ").eq("id",t).single();n?console.error("Error cargando job:",n):e&&e.client_lat&&e.client_lng&&b({lat:e.client_lat,lng:e.client_lng})})()},[t]),(0,r.useEffect)(()=>{if(!navigator.geolocation)return;let e=navigator.geolocation.watchPosition(async e=>{let n={lat:e.coords.latitude,lng:e.coords.longitude};a(n),t&&await o.supabase.from("jobs").update({worker_lat:n.lat,worker_lng:n.lng,status:"on_route"}).eq("id",t),i&&I(n,i)},e=>console.error("GPS error:",e),{enableHighAccuracy:!0});return()=>navigator.geolocation.clearWatch(e)},[i,t]),(0,r.useEffect)(()=>{if(!n||!i)return;let e=setInterval(()=>I(n,i),5e3);return()=>clearInterval(e)},[n,i]),(0,l.jsxs)("div",{className:"container",children:[(0,l.jsx)("h1",{className:"text-xl font-bold mb-3",children:"Ruta hacia el cliente"}),(0,l.jsxs)("div",{style:{height:"70vh"},className:"rounded-xl overflow-hidden relative",children:[n&&i&&(0,l.jsxs)(s,{center:n,zoom:14,style:{height:"100%",width:"100%"},children:[(0,l.jsx)(u,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),(0,l.jsx)(c,{position:n,icon:p("/avatar-worker.png"),children:(0,l.jsx)(f,{children:"Tu ubicaci\xf3n"})}),(0,l.jsx)(c,{position:i,icon:p("/avatar-client.png"),children:(0,l.jsx)(f,{children:"Cliente"})}),g.length>0&&(0,l.jsx)(d,{positions:g,pathOptions:{color:"#14B8A6",weight:5}})]}),null!==x&&null!==y&&(0,l.jsx)("div",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 bg-zinc-900/90 border border-white/10 rounded-2xl px-5 py-4 text-center shadow-xl w-[90%] max-w-md",children:v?(0,l.jsx)("div",{className:"text-green-400 font-semibold",children:"Has llegado al destino ✅"}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{className:"font-bold text-lg text-white",children:"\uD83D\uDE97 En camino"}),(0,l.jsxs)("div",{className:"text-sm text-white/80 mb-3",children:[y," km • ",x," min aprox"]}),(0,l.jsx)("button",{onClick:P,className:"btn btn-primary w-full py-2 rounded-lg",children:"✅ Llegu\xe9"})]})})]})]})}},4667:function(e,t,n){"use strict";n.d(t,{S:function(){return a}});var l=n(951);let r=null;function a(){if(r)return r;let e="https://ydtficoxjuxsoaxtghhj.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkdGZpY294anV4c29heHRnaGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTUwNDIsImV4cCI6MjA3NTY3MTA0Mn0.KBRDCAJYvjpmcXRnYFcuSI8Mn0zYfJzaN0QJo63gzy8";if(!e||!t)throw console.error("❌ Faltan variables de entorno de Supabase."),Error("Variables de entorno Supabase no configuradas.");return r=(0,l.createBrowserClient)(e,t,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}),console.log("✅ Supabase (browser client) inicializado en",e),r}},7818:function(e,t,n){"use strict";n.d(t,{default:function(){return r.a}});var l=n(551),r=n.n(l)},551:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return a}});let l=n(9920);n(7437),n(2265);let r=l._(n(148));function a(e,t){var n;let l={loading:e=>{let{error:t,isLoading:n,pastDelay:l}=e;return null}};"function"==typeof e&&(l.loader=e);let a={...l,...t};return(0,r.default)({...a,modules:null==(n=a.loadableGenerated)?void 0:n.modules})}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},912:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"BailoutToCSR",{enumerable:!0,get:function(){return r}});let l=n(5592);function r(e){let{reason:t,children:n}=e;if("undefined"==typeof window)throw new l.BailoutToCSRError(t);return n}},148:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return u}});let l=n(7437),r=n(2265),a=n(912),o=n(1481);function i(e){return{default:e&&"default"in e?e.default:e}}let s={loader:()=>Promise.resolve(i(()=>null)),loading:null,ssr:!0},u=function(e){let t={...s,...e},n=(0,r.lazy)(()=>t.loader().then(i)),u=t.loading;function c(e){let i=u?(0,l.jsx)(u,{isLoading:!0,pastDelay:!0,error:null}):null,s=t.ssr?(0,l.jsxs)(l.Fragment,{children:["undefined"==typeof window?(0,l.jsx)(o.PreloadCss,{moduleIds:t.modules}):null,(0,l.jsx)(n,{...e})]}):(0,l.jsx)(a.BailoutToCSR,{reason:"next/dynamic",children:(0,l.jsx)(n,{...e})});return(0,l.jsx)(r.Suspense,{fallback:i,children:s})}return c.displayName="LoadableComponent",c}},1481:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"PreloadCss",{enumerable:!0,get:function(){return a}});let l=n(7437),r=n(8512);function a(e){let{moduleIds:t}=e;if("undefined"!=typeof window)return null;let n=(0,r.getExpectedRequestStore)("next/dynamic css"),a=[];if(n.reactLoadableManifest&&t){let e=n.reactLoadableManifest;for(let n of t){if(!e[n])continue;let t=e[n].files.filter(e=>e.endsWith(".css"));a.push(...t)}}return 0===a.length?null:(0,l.jsx)(l.Fragment,{children:a.map(e=>(0,l.jsx)("link",{precedence:"dynamic",rel:"stylesheet",href:n.assetPrefix+"/_next/"+encodeURI(e),as:"style"},e))})}},966:function(){}},function(e){e.O(0,[2733,4212,951,2971,7023,1744],function(){return e(e.s=6516)}),_N_E=e.O()}]);