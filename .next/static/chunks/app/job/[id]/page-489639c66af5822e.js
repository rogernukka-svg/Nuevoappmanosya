(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1534],{3835:function(e,t,a){Promise.resolve().then(a.bind(a,9433))},9433:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return h}});var s=a(7437),n=a(2265),l=a(6463),r=a(7138),i=a(7818);a(966);var o=a(4667);let d={open:"Publicado",taken:"Asignado",started:"En curso",completed:"Completado",canceled:"Cancelado"},c=["No se present\xf3","Demora excesiva","Mal servicio","Da\xf1o material","Comportamiento inapropiado","Seguridad","Otro"],u=(0,i.default)(()=>Promise.all([a.e(4212),a.e(9720),a.e(9748)]).then(a.bind(a,9720)).then(e=>e.MapContainer),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),m=(0,i.default)(()=>Promise.all([a.e(4212),a.e(9720),a.e(9748)]).then(a.bind(a,9720)).then(e=>e.TileLayer),{loadableGenerated:{webpack:()=>[9720]},ssr:!1}),f=(0,i.default)(()=>Promise.all([a.e(4212),a.e(9720),a.e(9748)]).then(a.bind(a,9720)).then(e=>e.Marker),{loadableGenerated:{webpack:()=>[9720]},ssr:!1});function h(){var e,t,a;let{id:i}=(0,l.useParams)(),h=Array.isArray(i)?i[0]:i,[j,g]=(0,n.useState)(null),[y,_]=(0,n.useState)(null),[N,w]=(0,n.useState)([]),[S,k]=(0,n.useState)(!0),[C,P]=(0,n.useState)(null),[I,M]=(0,n.useState)(!1),[R,E]=(0,n.useState)(c[0]),[U,O]=(0,n.useState)(""),[T,A]=(0,n.useState)(!1),[D,F]=(0,n.useState)(null),[z,J]=(0,n.useState)(null),G=(0,n.useMemo)(()=>!!y&&!!j&&(y.client_id===j.id||y.worker_id===j.id),[y,j]),L=(0,n.useMemo)(()=>y&&j&&y.client_id===j.id,[y,j]),q=(0,n.useMemo)(()=>y&&j&&y.worker_id===j.id,[y,j]);async function B(){let{data:e,error:t}=await o.supabase.from("jobs").select("\n        id, title, description, skill_slug, status, price_offer,\n        address_text, created_at, lat, lon,\n        client_id,\n        worker_id,\n        client:profiles!jobs_client_id_fkey(id, full_name, avatar_url, verified),\n        worker:profiles!jobs_worker_id_fkey(id, full_name, avatar_url, verified)\n      ").eq("id",h).maybeSingle();if(t)throw t;_(e)}async function Y(){let{data:e,error:t}=await o.supabase.from("job_photos").select("id, path, created_at, created_by").eq("job_id",h).order("created_at",{ascending:!0});if(t)throw t;w(e||[])}async function V(e){try{let{error:t}=await o.supabase.rpc(e,{job_id:h});if(t)throw t;await B()}catch(e){alert(String(e.message||e))}}(0,n.useEffect)(()=>{(async()=>{k(!0);try{var e;let{data:t}=await o.supabase.auth.getUser();g(null!==(e=null==t?void 0:t.user)&&void 0!==e?e:null),await B(),await Y()}catch(e){P(String(e.message||e))}finally{k(!1)}})()},[h]);let X=(0,n.useMemo)(()=>(null==y?void 0:y.status)==="open"&&!L,[y,L]),Z=(0,n.useMemo)(()=>(null==y?void 0:y.status)==="taken"&&q,[y,q]),H=(0,n.useMemo)(()=>(null==y?void 0:y.status)==="started"&&(q||L),[y,q,L]),Q=(0,n.useMemo)(()=>["open","taken","started"].includes(null==y?void 0:y.status)&&(q||L),[y,q,L]);async function K(e){var t,a;null===(t=e.preventDefault)||void 0===t||t.call(e),A(!0),J(null),F(null);try{let{data:e}=await o.supabase.auth.getUser(),t=null==e?void 0:null===(a=e.user)||void 0===a?void 0:a.id;if(!t)throw Error("Sesi\xf3n inv\xe1lida");let s=L?null==y?void 0:y.worker_id:null==y?void 0:y.client_id,n={job_id:h,reporter_id:t,target_user_id:s||null,type:R,details:(null==U?void 0:U.trim())||null},{error:l}=await o.supabase.from("incidents").insert(n);if(l)throw l;F("Reporte enviado. Gracias por avisarnos."),setTimeout(()=>M(!1),1200)}catch(e){J(String(e.message||e))}finally{A(!1)}}if(S)return(0,s.jsx)("div",{className:"container",children:(0,s.jsx)("div",{className:"card p-5 mt-6",children:"Cargando…"})});if(C)return(0,s.jsx)("div",{className:"container",children:(0,s.jsx)("div",{className:"card p-5 mt-6 text-red-400",children:C})});if(!y)return(0,s.jsx)("div",{className:"container",children:(0,s.jsx)("div",{className:"card p-5 mt-6",children:"Trabajo no encontrado."})});let W="number"==typeof y.lat&&"number"==typeof y.lon;return(0,s.jsxs)("div",{className:"container",children:[(0,s.jsxs)("section",{className:"card p-5 mt-6",children:[(0,s.jsxs)("div",{className:"flex items-start gap-4 flex-wrap",children:[(0,s.jsxs)("div",{className:"flex-1 min-w-[260px]",children:[(0,s.jsx)("h1",{className:"font-heading text-2xl font-extrabold tracking-tight",children:y.title||"Trabajo"}),(0,s.jsxs)("div",{className:"text-white/70 text-sm mt-1",children:[null===(e=y.skill_slug)||void 0===e?void 0:e.toUpperCase()," \xb7 ",d[y.status]||y.status]}),y.address_text&&(0,s.jsx)("div",{className:"text-white/60 text-sm mt-1",children:y.address_text}),null!=y.price_offer&&(0,s.jsxs)("div",{className:"font-heading font-extrabold text-xl mt-2",children:["Gs. ",Number(y.price_offer).toLocaleString()]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[(0,s.jsx)(x,{title:"Cliente",p:y.client}),(0,s.jsx)(x,{title:"Profesional",p:y.worker,emptyText:"A\xfan sin asignar"})]})]}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-3 mt-4",children:[X&&(0,s.jsx)("button",{onClick:()=>V("take_job"),className:"btn btn-primary",children:"Tomar trabajo"}),Z&&(0,s.jsx)("button",{onClick:()=>V("start_job"),className:"btn btn-primary",children:"Iniciar"}),H&&(0,s.jsx)("button",{onClick:()=>V("complete_job"),className:"btn btn-primary",children:"Marcar como completado"}),Q&&(0,s.jsx)("button",{onClick:()=>V("cancel_job"),className:"btn btn-ghost",children:"Cancelar"}),(0,s.jsx)(r.default,{href:"/worker/nearby",className:"btn btn-ghost",children:"Volver"}),(0,s.jsx)(r.default,{href:"/chat/".concat(y.id),className:"btn btn-ghost",children:"Abrir chat"}),G&&(0,s.jsx)("button",{className:"btn btn-ghost",onClick:function(){E(c[0]),O(""),F(null),J(null),M(!0)},children:"Reportar problema"})]}),y.description&&(0,s.jsx)("div",{className:"text-white/80 text-sm mt-4 whitespace-pre-line",children:y.description})]}),W&&(0,s.jsxs)("section",{className:"card p-4 mt-4",children:[(0,s.jsx)("h3",{className:"font-heading font-extrabold text-lg mb-3",children:"Ubicaci\xf3n aproximada"}),(0,s.jsx)("div",{className:"w-full overflow-hidden rounded-2xl",style:{height:320},children:(0,s.jsxs)(u,{center:[y.lat,y.lon],zoom:14,style:{height:"100%",width:"100%"},children:[(0,s.jsx)(m,{url:"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"}),(0,s.jsx)(f,{position:[y.lat,y.lon]})]})}),(0,s.jsxs)("div",{className:"text-xs text-white/60 mt-2",children:[y.lat.toFixed(4),", ",y.lon.toFixed(4)]})]}),(0,s.jsxs)("section",{className:"grid lg:grid-cols-2 gap-6 mt-6",children:[(0,s.jsx)(p,{jobId:h,canUpload:G,photos:N,refresh:Y}),(0,s.jsx)(b,{jobId:h,canChat:G})]}),I&&(0,s.jsx)(v,{onClose:function(){M(!1)},type:R,setType:E,details:U,setDetails:O,onSubmit:K,busy:T,msg:D,error:z,otherSideName:L?(null===(t=y.worker)||void 0===t?void 0:t.full_name)||"el profesional":(null===(a=y.client)||void 0===a?void 0:a.full_name)||"el cliente"})]})}function x(e){let{title:t,p:a,emptyText:n}=e;return(0,s.jsxs)("div",{className:"card p-3 w-[240px]",children:[(0,s.jsx)("div",{className:"text-white/60 text-xs",children:t}),a?(0,s.jsxs)("div",{className:"flex items-center gap-3 mt-2",children:[(0,s.jsx)("img",{src:a.avatar_url||"/avatar-fallback.png",alt:"",style:{width:44,height:44,borderRadius:"50%",objectFit:"cover",border:"2px solid var(--accent)"}}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"font-heading font-extrabold",children:a.full_name||"Usuario"}),(0,s.jsx)("div",{className:"text-white/60 text-xs",children:a.verified?"Verificado ✓":"No verificado"})]})]}):(0,s.jsx)("div",{className:"text-white/60 text-sm mt-2",children:n||"—"})]})}function p(e){let{jobId:t,canUpload:a,photos:l,refresh:r}=e,[i,d]=(0,n.useState)(!1),[c,u]=(0,n.useState)(null);async function m(e){let a=Array.from(e.target.files||[]).slice(0,3);if(a.length){d(!0),u(null);try{var s;let{data:e}=await o.supabase.auth.getUser(),n=null==e?void 0:null===(s=e.user)||void 0===s?void 0:s.id;for(let e of a){let a=e.name.split(".").pop(),s="".concat(t,"/").concat(crypto.randomUUID(),".").concat(a),{error:l}=await o.supabase.storage.from("job-photos").upload(s,e,{upsert:!1});if(l)throw l;await o.supabase.from("job_photos").insert({job_id:t,path:s,created_by:n})}await r()}catch(e){u(String(e.message||e))}finally{d(!1)}}}return(0,s.jsxs)("div",{className:"card p-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("h3",{className:"font-heading font-extrabold text-lg",children:"Fotos"}),a&&(0,s.jsxs)("label",{className:"btn btn-ghost",children:[i?"Subiendo…":"Subir",(0,s.jsx)("input",{type:"file",accept:"image/*",multiple:!0,onChange:m,hidden:!0})]})]}),c&&(0,s.jsx)("div",{className:"text-red-400 text-sm mt-2",children:c}),(null==l?void 0:l.length)?(0,s.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3 mt-3",children:l.map(e=>{let{data:t}=o.supabase.storage.from("job-photos").getPublicUrl(e.path),a=t.publicUrl;return(0,s.jsx)("a",{href:a,target:"_blank",rel:"noreferrer",className:"block",children:(0,s.jsx)("img",{src:a,alt:"",className:"w-full h-36 object-cover rounded-2xl"})},e.id)})}):(0,s.jsx)("div",{className:"text-white/50 text-sm mt-2",children:"A\xfan no hay fotos."})]})}function b(e){let{jobId:t,canChat:a}=e,[l,i]=(0,n.useState)([]),[d,c]=(0,n.useState)(""),[u,m]=(0,n.useState)(null),f=(0,n.useRef)(null),[h,x]=(0,n.useState)(null);function p(){let e=f.current;e&&(e.scrollTop=e.scrollHeight)}async function b(e){e.preventDefault(),m(null);let a=d.trim();if(a)try{var s;let{data:e}=await o.supabase.auth.getUser(),n=null==e?void 0:null===(s=e.user)||void 0===s?void 0:s.id,{error:l}=await o.supabase.from("messages").insert({job_id:t,sender_id:n,body:a});if(l)throw l;c("")}catch(e){m(String(e.message||e))}}return(0,n.useEffect)(()=>{(async()=>{var e;m(null);let{data:a}=await o.supabase.auth.getUser();x(null!==(e=null==a?void 0:a.user)&&void 0!==e?e:null);try{let{data:e,error:a}=await o.supabase.from("messages").select("id, job_id, sender_id, body, created_at, sender:profiles!messages_sender_id_fkey(full_name, avatar_url)").eq("job_id",t).order("created_at",{ascending:!0});if(a)throw a;i(e||[])}catch(e){m(String(e.message||e))}})();let e=o.supabase.channel("msgs:".concat(t)).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:"job_id=eq.".concat(t)},e=>{i(t=>[...t,e.new]),p()}).subscribe();return()=>{o.supabase.removeChannel(e)}},[t]),(0,n.useEffect)(()=>{p()},[l.length]),(0,s.jsxs)("div",{className:"card p-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("h3",{className:"font-heading font-extrabold text-lg",children:"Chat"}),(0,s.jsx)(r.default,{href:"/chat/".concat(t),className:"btn btn-ghost",children:"Abrir chat completo"})]}),u&&(0,s.jsx)("div",{className:"text-red-400 text-sm mb-2",children:u}),(0,s.jsxs)("div",{ref:f,className:"h-[320px] overflow-y-auto rounded-2xl p-3",style:{background:"rgba(255,255,255,.03)"},children:[0===l.length&&(0,s.jsx)("div",{className:"text-white/50 text-sm",children:"A\xfan no hay mensajes."}),l.map(e=>(0,s.jsx)(j,{m:e,meId:null==h?void 0:h.id},e.id))]}),(0,s.jsxs)("form",{onSubmit:b,className:"mt-3 flex gap-2",children:[(0,s.jsx)("input",{className:"input",placeholder:a?"Escrib\xed un mensaje…":"Solo participantes pueden chatear",value:d,onChange:e=>c(e.target.value),disabled:!a}),(0,s.jsx)("button",{className:"btn btn-primary",disabled:!a||!d.trim(),children:"Enviar"})]})]})}function j(e){var t,a;let{m:n,meId:l}=e,r=n.created_at?new Date(n.created_at).toLocaleString():"",i=(null===(t=n.sender)||void 0===t?void 0:t.full_name)||"Usuario",o=(null===(a=n.sender)||void 0===a?void 0:a.avatar_url)||"/avatar-fallback.png",d=l&&n.sender_id===l;return(0,s.jsx)("div",{className:"flex ".concat(d?"justify-end":"justify-start"," py-1"),children:(0,s.jsxs)("div",{className:"px-3 py-2 rounded-2xl text-sm max-w-[78%] flex gap-2 items-start",style:{background:d?"var(--accent)":"rgba(255,255,255,0.08)",color:d?"#0B0D0F":"#fff"},title:r,children:[!d&&(0,s.jsx)("img",{src:o,alt:"",style:{width:22,height:22,borderRadius:"50%",objectFit:"cover"}}),(0,s.jsxs)("div",{children:[!d&&(0,s.jsx)("div",{className:"text-white/70 text-[11px] leading-none mb-1",children:i}),(0,s.jsx)("div",{className:"whitespace-pre-line",children:n.body})]})]})})}function v(e){let{onClose:t,type:a,setType:n,details:l,setDetails:r,onSubmit:i,busy:o,msg:d,error:u,otherSideName:m}=e;return(0,s.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",style:{background:"rgba(0,0,0,.6)"},role:"dialog","aria-modal":"true",children:(0,s.jsxs)("div",{className:"card p-5 w-[92vw] max-w-xl",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("h3",{className:"font-heading text-xl font-extrabold",children:"Reportar problema"}),(0,s.jsx)("button",{className:"btn btn-ghost",onClick:t,children:"Cerrar"})]}),(0,s.jsxs)("div",{className:"text-white/70 text-sm mt-2",children:["Este reporte se enviar\xe1 a soporte. Est\xe1s reportando a ",(0,s.jsx)("b",{children:m}),"."]}),(0,s.jsxs)("form",{className:"mt-4 space-y-3",onSubmit:i,children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"label",children:"Tipo"}),(0,s.jsx)("select",{className:"select",value:a,onChange:e=>n(e.target.value),children:c.map(e=>(0,s.jsx)("option",{value:e,children:e},e))})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"label",children:"Detalles"}),(0,s.jsx)("textarea",{className:"input",rows:5,placeholder:"Contanos qu\xe9 pas\xf3…",value:l,onChange:e=>r(e.target.value)})]}),u&&(0,s.jsx)("div",{className:"text-red-400 text-sm",children:u}),d&&(0,s.jsx)("div",{className:"text-green-400 text-sm",children:d}),(0,s.jsxs)("div",{className:"flex gap-3",children:[(0,s.jsx)("button",{type:"submit",className:"btn btn-primary",disabled:o,children:o?"Enviando…":"Enviar reporte"}),(0,s.jsx)("button",{type:"button",className:"btn btn-ghost",onClick:t,children:"Cancelar"})]})]})]})})}},4667:function(e,t,a){"use strict";a.d(t,{S:function(){return l}});var s=a(951);let n=null;function l(){if(n)return n;let e="https://ydtficoxjuxsoaxtghhj.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkdGZpY294anV4c29heHRnaGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTUwNDIsImV4cCI6MjA3NTY3MTA0Mn0.KBRDCAJYvjpmcXRnYFcuSI8Mn0zYfJzaN0QJo63gzy8";if(!e||!t)throw console.error("❌ Faltan variables de entorno de Supabase."),Error("Variables de entorno Supabase no configuradas.");return n=(0,s.createBrowserClient)(e,t,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}),console.log("✅ Supabase (browser client) inicializado en",e),n}},7818:function(e,t,a){"use strict";a.d(t,{default:function(){return n.a}});var s=a(551),n=a.n(s)},7138:function(e,t,a){"use strict";a.d(t,{default:function(){return n.a}});var s=a(231),n=a.n(s)},6463:function(e,t,a){"use strict";var s=a(1169);a.o(s,"useParams")&&a.d(t,{useParams:function(){return s.useParams}}),a.o(s,"usePathname")&&a.d(t,{usePathname:function(){return s.usePathname}}),a.o(s,"useRouter")&&a.d(t,{useRouter:function(){return s.useRouter}})},551:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return l}});let s=a(9920);a(7437),a(2265);let n=s._(a(148));function l(e,t){var a;let s={loading:e=>{let{error:t,isLoading:a,pastDelay:s}=e;return null}};"function"==typeof e&&(s.loader=e);let l={...s,...t};return(0,n.default)({...l,modules:null==(a=l.loadableGenerated)?void 0:a.modules})}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},912:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"BailoutToCSR",{enumerable:!0,get:function(){return n}});let s=a(5592);function n(e){let{reason:t,children:a}=e;if("undefined"==typeof window)throw new s.BailoutToCSRError(t);return a}},148:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return d}});let s=a(7437),n=a(2265),l=a(912),r=a(1481);function i(e){return{default:e&&"default"in e?e.default:e}}let o={loader:()=>Promise.resolve(i(()=>null)),loading:null,ssr:!0},d=function(e){let t={...o,...e},a=(0,n.lazy)(()=>t.loader().then(i)),d=t.loading;function c(e){let i=d?(0,s.jsx)(d,{isLoading:!0,pastDelay:!0,error:null}):null,o=t.ssr?(0,s.jsxs)(s.Fragment,{children:["undefined"==typeof window?(0,s.jsx)(r.PreloadCss,{moduleIds:t.modules}):null,(0,s.jsx)(a,{...e})]}):(0,s.jsx)(l.BailoutToCSR,{reason:"next/dynamic",children:(0,s.jsx)(a,{...e})});return(0,s.jsx)(n.Suspense,{fallback:i,children:o})}return c.displayName="LoadableComponent",c}},1481:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"PreloadCss",{enumerable:!0,get:function(){return l}});let s=a(7437),n=a(8512);function l(e){let{moduleIds:t}=e;if("undefined"!=typeof window)return null;let a=(0,n.getExpectedRequestStore)("next/dynamic css"),l=[];if(a.reactLoadableManifest&&t){let e=a.reactLoadableManifest;for(let a of t){if(!e[a])continue;let t=e[a].files.filter(e=>e.endsWith(".css"));l.push(...t)}}return 0===l.length?null:(0,s.jsx)(s.Fragment,{children:l.map(e=>(0,s.jsx)("link",{precedence:"dynamic",rel:"stylesheet",href:a.assetPrefix+"/_next/"+encodeURI(e),as:"style"},e))})}},966:function(){}},function(e){e.O(0,[2733,951,231,2971,7023,1744],function(){return e(e.s=3835)}),_N_E=e.O()}]);